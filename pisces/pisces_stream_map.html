<head>

    <!-- jquery -->
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- datatables import -->
    <link rel="stylesheet"
          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js -->
    <script src="/static_qed/pisces/scripts/waterslayer.js"></script>
    <script src="/static_qed/pisces/scripts/pisces_datatable.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>

    <style>
        #map {
            width: 100%;
            height: 450px;
        }

        #streamData {
            padding: 10px;
            width: 100%;
        }

        {#datatables font size#}
        th {
            font-size: 12px;
        }

        td {
            font-size: 11px;
        }

        .table {
            border-bottom: 0 !important;
        }

        .region-highlighted {
            margin: 0 0 0 0 !important;
        }

        #fishTable tr *, td * {
            border: 0 !important;
            text-align: center !important;
        }

        #fishTable th * {
            border: 0 !important;
            border-bottom: solid;
            border-bottom-width: 1px;
        }

        #filteredFishTable tr *, td * {
            border: 0 !important;
            text-align: center !important;
        }

        #filteredFishTable th * {
            border: 0 !important;
            border-bottom: solid;
            border-bottom-width: 1px;
        }

        .box > .pane-content {
            border-bottom-width: 1px !important;
        }

        {#remove all EPA css transitions for leaflet map#}
        div.mapNoTransition * {
            -o-transition-property: none !important;
            -moz-transition-property: none !important;
            -ms-transition-property: none !important;
            -webkit-transition-property: none !important;
            transition-property: none !important;
            transition: none !important;
        }

        .stream_info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        #stream_info h5 {
            margin: 0 0 5px;
            color: #777;
        }

        #stream_info_table table {
            width: 100%;
        }

        #stream_info_table td {
            font-size: 9px;
            border: none !important;
            background: rgba(255, 255, 255, 0.0);
            padding: 2px 3px !important;
        }

        {# Filter Buttons #}
        .filterButton {
            width: 100% !important;
            height: 30px !important;
            color: black;
            text-align: center !important;
            text-decoration: none !important;
            display: inline-block !important;
            font-size: 12px !important;
            border-radius: 12px !important;
            margin: 5px 0 !important;
            white-space: nowrap !important;
            padding: 0 !important;
            box-shadow: inset 0px 1px 0px #2ab7ec, 0px 1px 0px 0px #07526e, 0px 5px 5px #999 !important;
        }

        .filterButton:hover {
            box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        }

        .fish_filter {
            border-radius: 4px;
            padding: 2px 4px 4px 4px;
            background-color: transparent;
        {#            width: 11%;#} width: 9%;
            margin: 0 1px;
            display: inline-block;
        }

        #filter_field {
            font-size: 10px;
        }

        #filter_field_left {
            width: 50%;
            float: left;
            font-size: 10px;
        }

        #filter_field_right {
            width: 50%;
            float: right;
            font-size: 10px;
        }

        tr.filteredInFishTable td {
            background-color: #86C1FF !important;
        }

        {# Accordion css #}
        button.accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px 18px;
            width: 100%;
        {#            text-align: left;#} border: none;
            outline: none;
            margin: 0 !important;
            text-align: center;
        }

        button.accordion.active, button.accordion:hover {
            background-color: #ddd;
        }

        div.panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            text-align: center;
        {#        transition: max-height 0.2s ease-out;#}
        }

        button.accordion:after {
            content: '\02795'; /* Unicode character for "plus" sign (+) */
            font-size: 13px;
            color: #777;
            float: right;
            margin-left: 5px;
        }

        button.accordion.active:after {
            content: "\2796"; /* Unicode character for "minus" sign (-) */
        }

        td.details-control {
            background: url('/static_qed/pisces/images/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.details-control {
            background: url('/static_qed/pisces/images/details_close.png') no-repeat center center;
        }

        div.filtering {
            background-color: #0099FF;
        }

        {# flipswitch css #}
        .envelope_toggle {
            position: relative;
            width: 100px;
            height: 24px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .envelope_toggle-checkbox {
            display: none;
        }

        .envelope_toggle-label {
            display: block;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #75A6D9;
            border-radius: 6px;
        }

        .envelope_toggle-inner {
            display: block;
            width: 200%;
            margin-left: -100%;
            transition: margin 0.3s ease-in 0s;
        }

        .envelope_toggle-inner:before, .envelope_toggle-inner:after {
            display: block;
            float: left;
            width: 50%;
            height: 24px;
            padding: 0;
            line-height: 24px;
            font-size: 12px;
            color: white;
            font-family: Trebuchet, Arial, sans-serif;
            font-weight: bold;
            box-sizing: border-box;
        }

        .envelope_toggle-inner:before {
            content: "Detailed";
            padding-left: 10px;
            background-color: #86C1FF;
            color: #FFFFFF;
        }

        .envelope_toggle-inner:after {
            content: "Rounded";
            padding-right: 10px;
            background-color: #EEEEEE;
            color: #999999;
            text-align: right;
        }

        .envelope_toggle-switch {
            display: block;
            width: 13px;
            margin: 5.5px;
            background: #FFFFFF;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 72px;
            border: 2px solid #75A6D9;
            border-radius: 6px;
            transition: all 0.3s ease-in 0s;
        }

        .envelope_toggle-checkbox:checked + .envelope_toggle-label .envelope_toggle-inner {
            margin-left: 0;
        }

        .envelope_toggle-checkbox:checked + .envelope_toggle-label .envelope_toggle-switch {
            right: 0px;
        }

    </style>

    <script>

        $(document).ready(function () {

            {#            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {#}
            {#                var depthValue = parseFloat(document.getElementsByClassName('depth_value')[0].value);#}
            {#                return table.columns(6).search(depthValue).draw();#}
            {#            });#}

            $('#fishTable').closest('div').hide();
            $('#filteredFishTable').closest('div').hide();
            $('#abundance_calc').closest('div').hide();
            $('#fish_filters').closest('div').hide();

            $('#selectHUC').on('change', function () {
                selectHUCs(this.value);
            });

            $('#accordion').click(expandFilter());

            $(document).on("click", ".filterButton", (function (event) {
                var input = $(this).closest('div');
                updateFilters(input);
            }));

            $(document).on('input', "#filter_field", function (event) {
                var input = $(this.closest('div'));
                if (input.hasClass("filtering")) {
                    updateFilters(input);
                }
            });

            // Add event listener for opening and closing details
            $('#fishTable').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = $('#fishTable').DataTable().row(tr);
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(formatDetails(row.data())).show();
                    tr.addClass('shown');
                }
            });
        });

        function updateFilters(input) {
            var fishTable = $('#fishTable').DataTable();
            if (input.hasClass("filtering")) {
                input.removeClass('filtering');
            }
            else {
                input.addClass('filtering');
            }
            var filters = $("#assemblage_filters").find(".filtering");
            var resetData = fishTable.rows().data();
            populateFilteredFishTable(resetData);
            fishTable.rows().nodes().to$().removeClass('filteredInFishTable');
            if (filters.length !== 0) {
                var filteredTable = $('#filteredFishTable').DataTable();
                var inTable = Array.apply(null, {length: fishTable.rows().count()}).map(Function.call, Number);
                filters.map(function (index) {
                    var filterName = filters[index].firstElementChild.name.split('_');
                    var notInTable = filterDataTable(Number(filterName[1]), Number(filterName[2]), filterName[0] + '_value');
                    for (var i = 0; i < notInTable.length; i++) {
                        var v = notInTable[i];
                        if (inTable.indexOf(v) !== -1) {
                            inTable.splice(inTable.indexOf(v), 1);
                        }
                    }
                });
                var filterData = filteredTable.rows(inTable).data();
                var genusIDs = filteredTable.cells(inTable, 3).data().toArray();
                fishTable.column(4, {order: 'index'}).data().filter(function (value, index) {
                    if (genusIDs.indexOf(value) >= 0) {
                        fishTable.row(index, {order: 'index'}).nodes().to$().addClass('filteredInFishTable');
                    }
                });
                populateFilteredFishTable(filterData);
            }
        }

        function filterDataTable(minColumn, maxColumn, compareValueName) {
            var filteredTable = $('#filteredFishTable').DataTable();
            var cValue = parseFloat(document.getElementsByClassName(compareValueName)[0].value);
            var notInTable = [];
            var filterTable = filteredTable.column(minColumn).data().filter(function (value, index) {
                if (value < cValue || isNaN(value) || value === null) {
                    return true;
                }
                else {
                    if (notInTable.indexOf(index) === -1) {
                        notInTable.push(index);
                    }
                    return false;
                }
            });
            var filterTable2 = filteredTable.column(maxColumn).data().filter(function (value, index) {
                if (value > cValue || isNaN(value) || value === null) {
                    return true;
                }
                else {
                    if (notInTable.indexOf(index) === -1) {
                        notInTable.push(index);
                    }
                    else {
                        notInTable.splice(notInTable.indexOf(index), 1);
                    }
                    return false;
                }
            });
            return notInTable;
        }

        function formatDetails(details) {
            return 'Max Size (cm): ' + details[10] + '<br>' +
                'Stream Depth Range (cm): (' + details[0] + ' - ' + details[6] + ')<br>' +
                'Stream Width Range (m): (' + details[16] + ' - ' + details[21] + ')<br>' +
                'Stream Area Range (ha): (' + details[2] + ' - ' + details[3] + ')<br>' +
                'Stream Slope Range (%): (' + details[15] + ' - ' + details[11] + ')<br>' +
                'Stream TSS Range (mg/l): (' + details[1] + ' - ' + details[8] + ')<br>' +
                'Stream pH Range: (' + details[13] + ' - ' + details[14] + ')<br>' +
                'Stream Conductivity Range (uS/cm2): (' + details[18] + ' - ' + details[22] + ')<br>' +
                'Stream Dissolved Oxygen Range (% sat): (' + details[19] + ' - ' + details[20] + ')<br>';
        }

        function onStreamMapClick(e) {
            document.getElementById('table-focus').focus();
            $('#fish_filters').closest('div').show();
            getStreamData(e.latlng.lat, e.latlng.lng);
            //getFishData();
            getTESTFishData();
        }

        function getStreamData(lat, lng) {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            var latitude = lat.toString();
            var longitude = lng.toString();
            $('#latVal').html(Number(latitude).toFixed(6));
            $('#lngVal').html(Number(longitude).toFixed(6));

            ptIndexParams = {
                'pGeometry': 'POINT(' + longitude + ' ' + latitude + ')'
                , 'pGeometryMod': 'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'pPointIndexingMethod': 'DISTANCE'
                , 'pPointIndexingMaxDist': 25
                , 'pOutputPathFlag': 'TRUE'
                , 'pReturnFlowlineGeomFlag': 'TRUE'
                , 'optOutCS': 'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'optOutPrettyPrint': 0
            };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    $('#comid').html(streamData.output.ary_flowlines[0].comid);
                    $('#huc8').html(streamData.output.ary_flowlines[0].wbd_huc12.substring(0, 8));
                    addStreamSeg(streamData);
                    return data;
                },
                error: function (jqXHR, status) {
                    $('#comId').html("Error attempting to get river data.");
                    return null;
                }
            });
        }

        function getFishData() {
            var ecoAJAX = JSON.stringify({"latitude": latitude, "longitude": longitude});
            var ecoURL = "/pisces/rest/ecoregion";
            $.ajax({
                type: "POST",
                url: ecoURL,
                data: ecoAJAX,
                crossDomain: true,
                success: function (data) {
                    var ecoData = JSON.parse(data);
                    $('#ecoRegionId').html(ecoData.gid);
                    $('#ecoRegionName').html(ecoData.region);
                },
                error: function (jqXHR, status) {
                    $('#error_msg').html("Error attempting to get ecoRegion data.");
                    return null;
                }
            });

            var huc8 = JSON.stringify([document.getElementById('#huc8').value]);
            $.ajax({
                type: "POST",
                url: "/pisces/rest/fishproperies",
                data: huc8,
                crossDomain: true,

                success: function (data) {
                    populateFishTable(data)
                },
                error: function (jqXHR, status) {
                    $('#error_msg').html("Error: failed to get fish data for the selected huc.");
                    return null;
                }
            });
        }

        function getTESTFishData() {
            var ecoData = {"region": "Coastal Plains", "gid": 9};
            $('#ecoRegionId').html(ecoData.gid);
            $('#ecoRegionName').html(ecoData.region);

            var testFishData = {
                "cognatus": {
                    "depth_l": 10.09,
                    "tss_l": 0.0001,
                    "area_l": 208.1,
                    "area_u": 25890.0,
                    "common_name": "slimy sculpin",
                    "genusID": 41,
                    "depth_u": 59.3727,
                    "species": "cognatus",
                    "tss_u": 22.2,
                    "species_id": 137,
                    "max_Size": 12.0,
                    "slope_u": 3.45,
                    "huc": "04030101",
                    "ph_l": 6.65,
                    "ph_u": 8.35,
                    "slope_l": 0.255,
                    "width_l": 2.025,
                    "genus": "Cottus",
                    "cond_l": 23.6,
                    "do_l": 47.5254,
                    "do_u": 95.1819,
                    "width_u": 18.51,
                    "cond_u": 534.0
                },
                "zenithicus": {
                    "depth_l": null,
                    "tss_l": null,
                    "area_l": null,
                    "area_u": null,
                    "common_name": "shortjaw cisco",
                    "genusID": 40,
                    "depth_u": null,
                    "species": "zenithicus",
                    "tss_u": null,
                    "species_id": 126,
                    "max_Size": 40.0,
                    "slope_u": null,
                    "huc": "04030101",
                    "ph_l": null,
                    "ph_u": null,
                    "slope_l": null,
                    "width_l": null,
                    "genus": "Coregonus",
                    "cond_l": null,
                    "do_l": null,
                    "do_u": null,
                    "width_u": null,
                    "cond_u": null
                },
                "heterolepis": {
                    "depth_l": 16.27,
                    "tss_l": 0.8,
                    "area_l": 595.8,
                    "area_u": 77418.0,
                    "common_name": "blacknose shiner",
                    "genusID": 134,
                    "depth_u": 66.32,
                    "species": "heterolepis",
                    "tss_u": 34.0,
                    "species_id": 706,
                    "max_Size": 10.0,
                    "slope_u": 2.0,
                    "huc": "04030101",
                    "ph_l": 7.1,
                    "ph_u": 8.43,
                    "slope_l": 0.2,
                    "width_l": 2.467,
                    "genus": "Notropis",
                    "cond_l": 46.0,
                    "do_l": 42.1327,
                    "do_u": 99.3147,
                    "width_u": 27.4545,
                    "cond_u": 883.0
                },
                "elongatus": {
                    "depth_l": 13.48,
                    "tss_l": 0.4,
                    "area_l": 129.4,
                    "area_u": 10614.0,
                    "common_name": "redside dace",
                    "genusID": 39,
                    "depth_u": 61.52,
                    "species": "elongatus",
                    "tss_u": 31.4,
                    "species_id": 109,
                    "max_Size": 12.0,
                    "slope_u": 3.25,
                    "huc": "04030101",
                    "ph_l": 6.56,
                    "ph_u": 8.18,
                    "slope_l": 0.1889,
                    "width_l": 1.25,
                    "genus": "Clinostomus",
                    "cond_l": 22.8,
                    "do_l": 49.0757,
                    "do_u": 90.2983,
                    "width_u": 14.25,
                    "cond_u": 496.0
                },
                "hankinsoni": {
                    "depth_l": null,
                    "tss_l": null,
                    "area_l": 1782.9,
                    "area_u": 279035.0,
                    "common_name": "brassy minnow",
                    "genusID": 86,
                    "depth_u": null,
                    "species": "hankinsoni",
                    "tss_u": null,
                    "species_id": 493,
                    "max_Size": 10.0,
                    "slope_u": null,
                    "huc": "04030101",
                    "ph_l": 6.81,
                    "ph_u": 8.13,
                    "slope_l": null,
                    "width_l": 4.02,
                    "genus": "Hybognathus",
                    "cond_l": 89.0,
                    "do_l": 24.8836,
                    "do_u": 82.509,
                    "width_u": 62.7273,
                    "cond_u": 388.4
                },
                "nigrum": {
                    "depth_l": 13.17,
                    "tss_l": 0.8,
                    "area_l": 213.6,
                    "area_u": 34914.5,
                    "common_name": "johnny darter",
                    "genusID": 69,
                    "depth_u": 63.7386,
                    "species": "nigrum",
                    "tss_u": 34.0,
                    "species_id": 352,
                    "max_Size": 7.0,
                    "slope_u": 2.44,
                    "huc": "04030101",
                    "ph_l": 6.85,
                    "ph_u": 8.36,
                    "slope_l": 0.155,
                    "width_l": 1.635,
                    "genus": "Etheostoma",
                    "cond_l": 43.0,
                    "do_l": 45.0836,
                    "do_u": 99.3147,
                    "width_u": 21.6364,
                    "cond_u": 714.0
                },
                "umbratilis": {
                    "depth_l": 23.68,
                    "tss_l": 2.5,
                    "area_l": 1997.9,
                    "area_u": 63266.0,
                    "common_name": "redfin shiner",
                    "genusID": 112,
                    "depth_u": 62.04,
                    "species": "umbratilis",
                    "tss_u": 15.8,
                    "species_id": 591,
                    "max_Size": 8.5,
                    "slope_u": 2.0,
                    "huc": "04030101",
                    "ph_l": 6.83,
                    "ph_u": 8.22,
                    "slope_l": 0.06,
                    "width_l": 4.4355,
                    "genus": "Lythrurus",
                    "cond_l": 36.7,
                    "do_l": 48.2465,
                    "do_u": 84.8443,
                    "width_u": 16.88,
                    "cond_u": 340.7
                }
            };
            populateFishTable(testFishData);
            var fishTableData = $('#fishTable').DataTable().rows().data();
            populateFilteredFishTable(fishTableData);
        }

        function populateFishTable(data) {
            var fishArray = [];
            $('#fishTable').DataTable().destroy();
            $('#fishTable').empty();
            Object.keys(data).forEach(function (key) {
                fishArray.push(Object.values(data[key]));
            });
            var config = {
                data: fishArray,
                "columns": [
                    {
                        "class": "details-control",
                        "orderable": false,
                        "data": null,
                        "defaultContent": ""
                    },
                    {
                        data: 4,
                        title: "Common Name",
                        name: "common_name"
                    },
                    {
                        data: 7,
                        title: "Scientific Name",
                        name: "scientific_name"
                    },
                    {
                        data: 17,
                        title: "Genus",
                        name: "genus"
                    },
                    {
                        data: 5,
                        title: "Genus Id",
                        name: "genus_id"
                    },
                    {
                        data: 9,
                        title: "Species Id",
                        name: "species_id"

                    },
                    {
                        data: 10,
                        title: "Max Size",
                        name: "max_size"
                    },
                    {
                        data: 0,
                        title: "Depth Lower",
                        name: "depth_lower"
                    },
                    {
                        data: 6,
                        title: "Depth Upper",
                        name: "depth_upper"
                    },
                    {
                        data: 16,
                        title: "Width Lower",
                        name: "width_lower"
                    },
                    {
                        data: 21,
                        title: "Width Upper",
                        name: "width_upper"
                    },
                    {
                        data: 2,
                        title: "Area Lower",
                        name: "area_lower"
                    },
                    {
                        data: 3,
                        title: "Area Upper",
                        name: "area_upper"
                    },
                    {
                        data: 1,
                        title: "TSS Lower",
                        name: "tss_lower"
                    },
                    {
                        data: 8,
                        title: "TSS Upper",
                        name: "tss_upper"
                    },
                    {
                        data: 15,
                        title: "Slope Lower",
                        name: "slope_lower"
                    },
                    {
                        data: 11,
                        title: "Slope Upper",
                        name: "slope_upper"
                    },
                    {
                        data: 12,
                        title: "HUC ID",
                        name: "huc_id"
                    },
                    {
                        data: 13,
                        title: "pH Lower",
                        name: "ph_lower"
                    },
                    {
                        data: 14,
                        title: "pH Upper",
                        name: "ph_upper"
                    },
                    {
                        data: 18,
                        title: "Conductivity Lower",
                        name: "conduct_lower"
                    },
                    {
                        data: 22,
                        title: "Conductivity Upper",
                        name: "conduct_upper"
                    },
                    {
                        data: 19,
                        title: "Dissolved Oxygen Lower",
                        name: "do_lower"
                    },
                    {
                        data: 20,
                        title: "Dissolved Oxygen Upper",
                        name: "do_upper"
                    }
                ],
                "columnDefs": [
                    {
                        "targets": [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[17] + ' ' + data;
                        },
                        "targets": 2
                    }
                ],
                searching: false,
                paging: false,
                bInfo: false,
                "order": [[1, 'asc']]

            };
            $('#fishTable').closest('div').show();
            $('#fishTable').DataTable(config);
        }

        function populateFilteredFishTable(data) {
            {#            var fishArray = [];#}
            var fishArray = data;
            $('#filteredFishTable').DataTable().destroy();
            $('#filteredFishTable').empty();
            {#            Object.keys(data).forEach(function (key) {#}
            {#                fishArray.push(Object.values(data[key]));#}
            {#            });#}
            var config = {
                data: fishArray,
                "columns": [
                    {
                        data: 4,
                        title: "Common Name",
                        name: "common_name"
                    },
                    {
                        data: 7,
                        title: "Scientific Name",
                        name: "scientific_name"
                    },
                    {
                        data: 17,
                        title: "Genus",
                        name: "genus"
                    },
                    {
                        data: 5,
                        title: "Genus Id",
                        name: "genus_id"
                    },
                    {
                        data: 9,
                        title: "Species Id",
                        name: "species_id"
                    },
                    {
                        data: 10,
                        title: "Max Size",
                        name: "max_size"
                    },
                    {
                        data: 0,
                        title: "Depth Lower",
                        name: "depth_lower"
                    },
                    {
                        data: 6,
                        title: "Depth Upper",
                        name: "depth_upper"
                    },
                    {
                        data: 16,
                        title: "Width Lower",
                        name: "width_lower"
                    },
                    {
                        data: 21,
                        title: "Width Upper",
                        name: "width_upper"
                    },
                    {
                        data: 2,
                        title: "Area Lower",
                        name: "area_lower"
                    },
                    {
                        data: 3,
                        title: "Area Upper",
                        name: "area_upper"
                    },
                    {
                        data: 1,
                        title: "TSS Lower",
                        name: "tss_lower"
                    },
                    {
                        data: 8,
                        title: "TSS Upper",
                        name: "tss_upper"
                    },
                    {
                        data: 15,
                        title: "Slope Lower",
                        name: "slope_lower"
                    },
                    {
                        data: 11,
                        title: "Slope Upper",
                        name: "slope_upper"
                    },
                    {
                        data: 12,
                        title: "HUC ID",
                        name: "huc_id"
                    },
                    {
                        data: 13,
                        title: "pH Lower",
                        name: "ph_lower"
                    },
                    {
                        data: 14,
                        title: "pH Upper",
                        name: "ph_upper"
                    },
                    {
                        data: 18,
                        title: "Conductivity Lower",
                        name: "cond_lower"
                    },
                    {
                        data: 22,
                        title: "Conductivity Upper",
                        name: "cond_upper"
                    },
                    {
                        data: 19,
                        title: "Dissolved Oxygen Lower",
                        name: "do_lower"
                    },
                    {
                        data: 20,
                        title: "Dissolved Oxygen Upper",
                        name: "do_upper"
                    }
                ],
                "columnDefs": [
                    {
                        "targets": [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[17] + ' ' + data;
                        },
                        "targets": 1
                    }
                ],
                regex: true,
                searching: false,
                paging: false,
                bInfo: false
            };
            $('#filteredFishTable').closest('div').show();
            $('#filteredFishTable').DataTable(config);
        }

        function addStreamSeg(streamData) {
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function (c) {
                return c.reverse();
            });
            var huc8 = getStreamHuc(streamData.output.ary_flowlines[0].wbd_huc12);
            var huc8geom;
            if (huc8[0][0] < 0) {
                huc8geom = huc8.map(function (c) {
                    return c.reverse();
                });
            }
            else {
                huc8geom = huc8;
            }

            if (map.hasLayer(selectedStream)) {
                map.removeLayer(selectedStream);
                map.removeLayer(streamHuc);
            }

            selectedStream = L.polyline(latlon, {
                color: '#02bfe7',
                weight: 8,
                opacity: 0.9,
                lineJoin: 'round'
            }).addTo(map);
            streamHuc = L.polygon(huc8geom, {
                color: 'white',
                weight: 2,
                opacity: 0.9,
                fillColor: '#9ecae1',
                fillOpacity: 0.3
            }).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function getStreamHuc(hucID) {
            var huc8 = null;
            L.geoJSON(huc8s, {
                filter: function (feature, layer) {
                    if (feature.properties.HUC_CODE === hucID.substring(0, 8)) {
                        huc8 = feature.geometry.coordinates[0];
                    }
                }
            });
            return huc8;
        }

    </script>
    <script>

        $(function () {
            $("#rarity_range").slider({
                range: true,
                min: 1,
                max: 10,
                values: [1, 10],
                slide: function (event, ui) {
                    $("#rarity_value").val(ui.values[0] + " - " + ui.values[1]);
                }
            });
            $("#rarity_value").val($("#rarity_range").slider("values", 0) +
                " - " + $("#rarity_range").slider("values", 1));
        });

        {# Accordion JS #}

        function expandFilter() {
            var acc = document.getElementsByClassName("accordion");
            var i;

            for (i = 0; i < acc.length; i++) {
                acc[i].onclick = function () {
                    this.classList.toggle("active");
                    var panel = this.nextElementSibling;
                    if (panel.style.maxHeight) {
                        panel.style.maxHeight = null;
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                }
            }
            return false;
        }
    </script>
</head>
<body>
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">

        <!--- content div -->
        <div class="col-md-10">
            <div class="box multi news">
                <div class="pane-content" id="mapDiv">
                    <p><strong>Zoom in and select a stream</strong> on the map to view a list of fish species associated
                        with the stream segment.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)" title="Base Map">
                            <option value="Topographic">Topographic</option>
                            <option value="Streets">Streets</option>
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="Imagery">Imagery</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                </div>
                <br class="row" id="streamData">
                <div id="fish_filters">
                    <button class="accordion">Fish Assemblage Filters</button>
                    <div class="panel" id="assemblage_filters" style="overflow: hidden;">

                        <div class="fish_filter">
                            <input id="rarity_filter" type="button" name="rarity_23" value="Rarity" class="filterButton"
                                   align="center" title="Filter fish by rarity."><br>
                            {#                            <input type="text" id="filter_field" class="rarity_value" placeholder="(cm)"#}
                            {#                                   title="Enter a value in centimeters.">#}
                            <label for="rarity_value"></label>
                            <input title="Rarity Range" type="text" id="rarity_value" readonly
                                   style="border:0; color:black; font-weight:bold; font-size: 12px; text-align: center; background-color: transparent;">
                            <div id="rarity_range" style="margin: 0 10px;"></div>
                        </div>
                        <div class="fish_filter">
                            <input id="depth_filter" type="button" name="depth_6_7" value="Depth" class="filterButton"
                                   align="center" title="Filter fish by stream depth."><br>
                            <input type="text" id="filter_field" class="depth_value" placeholder="(cm)"
                                   title="Enter a value in centimeters.">
                        </div>
                        <div class="fish_filter">
                            <input id="width_filter" type="button" name="width_8_9" value="Width" class="filterButton"
                                   align="center" title="Filter fish by stream width."><br>
                            <input type="text" id="filter_field" class="width_value" placeholder="(m)"
                                   title="Enter a value in meters.">
                        </div>
                        <div class="fish_filter">
                            <input id="area_filter" type="button" name="area_10_11" value="Area" class="filterButton"
                                   align="center" title="Filter fish by stream drainage area."><br>
                            <input type="text" id="filter_field" class="area_value" placeholder="(ha)"
                                   title="Enter a value in hectares.">
                        </div>
                        <div class="fish_filter">
                            <input id="slope_filter" type="button" name="slope_14_15" value="Slope" class="filterButton"
                                   align="center" title="Filter fish by stream slope."><br>
                            <input type="text" id="filter_field" class="slope_value" placeholder="(%)"
                                   title="Enter a value as a percent grade.">
                        </div>
                        <div class="fish_filter">
                            <input id="tss_filter" type="button" name="tss_12_13" value="TSS" class="filterButton"
                                   align="center" title="Filter fish by stream tss."><br>
                            <input type="text" id="filter_field" class="tss_value" placeholder="(mg/l)"
                                   title="Enter a value in milligrams per liter.">
                        </div>
                        <div class="fish_filter">
                            <input id="ph_filter" type="button" name="ph_17_18" value="pH" class="filterButton"
                                   align="center" title="Filter fish by stream pH."><br>
                            <input type="text" id="filter_field" class="ph_value" placeholder="(SU)"
                                   title="Enter a value in standard units.">
                        </div>
                        <div class="fish_filter">
                            <input id="cond_filter" type="button" name="cond_19_20" value="Conductivity"
                                   class="filterButton" align="center" title="Filter fish by stream conductivity."><br>
                            <input type="text" id="filter_field" class="cond_value" placeholder="(uS/cm2)"
                                   title="Enter a value in micro-Siemens per square centimeter.">
                        </div>
                        <div class="fish_filter">
                            <input id="do_filter" type="button" name="do_21_22" value="Dissolved Oxygen"
                                   class="filterButton" align="center"
                                   title="Filter fish by stream dissolved oxygen."><br>
                            <input type="text" id="filter_field" class="do_value" placeholder="(% sat)"
                                   title="Enter a value as percentage.">
                        </div>
                    </div>
                </div>
                <br>
{#                <div class="envelope_toggle">#}
{#                    <input type="checkbox" name="envelope_toggle" class="envelope_toggle-checkbox"#}
{#                           id="myenvelope_toggle"#}
{#                           checked>#}
{#                    <label class="envelope_toggle-label" for="myenvelope_toggle">#}
{#                        <span class="envelope_toggle-inner"></span>#}
{#                        <span class="envelope_toggle-switch"></span>#}
{#                    </label>#}
{#                </div>#}
                <div class="col-md-12">
                    <div id="error_msg"></div>
                    <div style="width: 45%; margin: auto; display: inline-block; float: left;">
                        <h4 style="text-align: center; width: 100%">Fish in Selected HUC</h4>
                        <table id="fishTable" class="display compact hover" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Scientific Name</th>
                                {#                                <th>Species</th>#}
                                <th>Genus</th>
                                <th>Genus ID</th>
                                <th>Species ID</th>
                                <th>Max Size</th>
                                <th>Depth - Lower</th>
                                <th>Depth - Upper</th>
                                <th>Width - Lower</th>
                                <th>Width - Upper</th>
                                <th>Area - Lower</th>
                                <th>Area - Upper</th>
                                <th>TSS - Lower</th>
                                <th>TSS - Upper</th>
                                <th>Slope - Lower</th>
                                <th>Slope - Upper</th>
                                <th>HUC ID</th>
                                <th>PH - Lower</th>
                                <th>PH - Upper</th>
                                <th>Cond - Lower</th>
                                <th>Cond - Upper</th>
                                <th>DO - Lower</th>
                                <th>DO - Upper</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="fish_assemblage_estimator"
                         style="width:45%; margin: auto; display: inline-block; float: left;">
                        <h4 style="text-align: center; width: 100%">Filtered Fish Assemblage</h4>
                        <table id="filteredFishTable" class="display compact hover" cellspacing="0" width="100%"
                               style="padding: 0 2px; margin: 0 2px;">
                            <thead>
                            <tr>
                                <th>Common Name</th>
                                <th>Scientific Name</th>
                                <th>Count</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="abundance_calc" style="width:45%; margin: auto; display: inline-block; float: left;">
                        <h4 style="text-align: center; width: 100%">Abundance Calculator</h4>
                    </div>
                    <div id="table-focus" tabindex="-1"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script> // initialize the map
var map = L.map('map').setView([33.95, -83.38], 11);
// sets variable for selected stream
var selectedStream;
// sets the Huc for the selected stream
var streamHuc;

// load a tile layer
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: ['a', 'b', 'c']
}).addTo(map);


// -------------- BASE MAP code -------------- //

var layer = L.esri.basemapLayer('Imagery').addTo(map);
var layerLabels;

function setBasemap(basemap) {
    if (layer) {
        map.removeLayer(layer);
    }

    layer = L.esri.basemapLayer(basemap);

    map.addLayer(layer);

    if (layerLabels) {
        map.removeLayer(layerLabels);
    }

    if (basemap === 'ShadedRelief'
        || basemap === 'Imagery'
        || basemap === 'Terrain'
        || basemap === 'Topographic'
    ) {
        layerLabels = L.esri.basemapLayer(basemap + 'Labels');
        map.addLayer(layerLabels);
    }
}

function changeBasemap(basemaps) {
    var basemap = basemaps.value;
    setBasemap(basemap);
    addStreams();
}

// ------------ STREAM NETWORK code ------------- //

//L.control.layers(streamNetwork).addTo(map);
function addStreams() {
    L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
        layers: 4,
        format: 'image/png',
        minZoom: 0,
        maxZoom: 18,
        transparent: true
    }).addTo(map);
}

map.on('click', onStreamMapClick);
addStreams();
// --------------- INFO WINDOW code -------------- //

var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'stream_info');
    this.update();
    return this._div;
};

info.update = function (props) {
    this._div.innerHTML = '<h5>Stream Segment Info</h5>' +
        '<table id="stream_info_table" style="margin-bottom: 0px !important; background: none !important;"> ' +
        '<tr><td>Latitude:</td> <td id="latVal"></td></tr>' +
        '<tr><td>Longitude:</td><td id="lngVal"></td></tr>' +
        '<tr><td>Com ID:</td><td id="comid"></td></tr>' +
        '<tr><td>EcoRegion Name:</td><td id="ecoRegionName"></td></tr>' +
        '<td>WBD HUC8:</td><td id="huc8"></td>';
};

info.addTo(map);

</script>
</body>

</html>