<style>
    #map {
        width: 100%;
        height: 450px;
    }
     #streamData {
        padding: 10px;
        width: 100%;
	}
    {#datatables font size#}
    th {
        font-size: 12px;
    }
    td {
        font-size: 11px;
    }
        {#remove all EPA css transitions for leaflet map#}
    * {
         -o-transition-property: none !important;
         -moz-transition-property: none !important;
         -ms-transition-property: none !important;
         -webkit-transition-property: none !important;
         transition-property: none !important;
    }
</style>

<head>

    <!-- jquery -->
    <script   src="http://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>

    <!-- datatables import -->
    <link rel="stylesheet" href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js -->
    <script src="/static_qed/pisces/scripts/waterslayer.js"></script>
    <script src="/static_qed/pisces/scripts/pisces_datatable.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>

    <script>
        $(document).ready(function () {

            $("#selectHUC").on('change', function () {
                selectHUCs(this.value);
            });
        });


        function onStreamMapClick(e){
            getStreamData(e.latlng.lat, e.latlng.lng);
        }

        function getStreamData(lat, lng)
        {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            latitude = lat.toString();
            longitude = lng.toString();
            $('#latVal').html(latitude);
            $('#lngVal').html(longitude);

            ptIndexParams = {
                 'pGeometry':'POINT(' + longitude + ' ' + latitude + ')'
                ,'pGeometryMod':'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                ,'pPointIndexingMethod':'DISTANCE'
                ,'pPointIndexingMaxDist':25
                ,'pOutputPathFlag':'TRUE'
                ,'pReturnFlowlineGeomFlag':'TRUE'
                ,'optOutCS':'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                ,'optOutPrettyPrint':0
                };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    $('#ecoRegionId').html(streamData.output.ary_flowlines[0].gnis_id);
                    $('#ecoRegionName').html(streamData.output.ary_flowlines[0].gnis_name);
                    $('#comid').html(streamData.output.ary_flowlines[0].comid);
                    $('#huc12').html(streamData.output.ary_flowlines[0].wbd_huc12);
                    addStreamSeg(streamData);
                    return data;
                },
                error: function (jqXHR, status) {
                    $('#ecoRegionId').html("ERROR");
                    return null;
                }
            })
        }

        function addStreamSeg(streamData){
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function(c){
                return c.reverse();
            });
            var huc8 = getStreamHuc(streamData.output.ary_flowlines[0].wbd_huc12);
            var huc8geom;
            if (huc8[0][0] < 0){
                huc8geom = huc8.map(function(c){
                    return c.reverse();
                });
            }
            else{
                huc8geom = huc8;
            }

            if (map.hasLayer(selectedStream)){
                map.removeLayer(selectedStream);
                map.removeLayer(streamHuc);
            }

            selectedStream = L.polyline(latlon, {color: '#02bfe7', weight: 8, opacity: 0.9, lineJoin: 'round'}).addTo(map);
            streamHuc = L.polygon(huc8geom, {color: 'white', weight: 2, opacity: 0.9, fillColor: '#9ecae1', fillOpacity: 0.3}).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function getStreamHuc(hucID){
            var huc8 = null;
            L.geoJSON(huc8s, {filter: function(feature, layer){
                if(feature.properties.HUC_CODE === hucID.substring(0,8)){
                    huc8 =  feature.geometry.coordinates[0];
                }
            }});
            return huc8;
        }


    </script>
</head>
<body>
  <div class="panel-display panel-1col clearfix" >
    <div class="panel-panel panel-col">

        <!--- content div -->
        <div class="col-md-10">
          <div class="box multi news">
            <div class="pane-content" id="mapDiv">
              <p><strong>Zoom in and select a stream</strong> on the map to view a list of fish species associated with the stream segment.</p>
                <!-- leaflet map div -->
                <div id="map"></div>
                <!-- strean data div -->
                <div class="row" id="streamData">
                    <div class="col-md-12">
                        <table id="fish_data_table" class="display" cellspacing="0" width="40%">
                            <tr>
                                <td>Latitude:</td>
                                <td id="latVal">0.00</td>
                                <td>Longitude:</td>
                                <td id="lngVal">0.00</td>
                                <td>Com ID</td>
                                <td id="comid"></td>
                            </tr>
                            <tr>
                                <td>EcoRegion ID:</td>
                                <td id="ecoRegionId">0</td>
                                <td>EcoRegion Name:</td>
                                <td id="ecoRegionName"></td>
                                <td>WBD HUC12</td>
                                <td id="huc12"></td>
                            </tr>

                                <tr><button onclick="getEcoRegion()">Get EcoRegion</button></tr>

                        </table>
                    </div>
                </div>
            </div>
          </div>
        </div>
    </div>
  </div>
<script> // initialize the map
    var map = L.map('map').setView([33.95, -83.38], 11);
    // sets variable for selected stream
    var selectedStream;
    // sets the Huc for the selected stream
    var streamHuc;

    // load a tile layer
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);

    //L.control.layers(streamNetwork).addTo(map);
    L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
        layers: 4,
        format: 'image/png',
        minZoom: 0,
        maxZoom: 18,
        transparent: true
    }).addTo(map);

    map.on('click', onStreamMapClick);
</script>
</body>

</html>