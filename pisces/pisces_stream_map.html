<head>

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- datatables import -->
    <link rel="stylesheet"
          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js -->
    <script src="/static_qed/pisces/scripts/waterslayer.js"></script>
    <script src="/static_qed/pisces/scripts/pisces_datatable.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>

    <style>
        #map {
            width: 100%;
            height: 500px;
        }

        #streamData {
            padding: 10px;
            width: 100%;
        }

        {#datatables font size#}
        th {
            font-size: 12px;
        }

        td {
            font-size: 11px;
        }

        .table {
            border-bottom: 0 !important;
        }

        .region-highlighted {
            margin: 0 0 0 0 !important;
        }

        #fishTable tr *, td * {
            border: 0 !important;
            text-align: center !important;
        }

        #fishTable th * {
            border: 0 !important;
            border-bottom: solid;
            border-bottom-width: 1px;
        }

        #filteredFishTable tr *, td * {
            border: 0 !important;
            text-align: center !important;
        }

        #filteredFishTable th * {
            border: 0 !important;
            border-bottom: solid;
            border-bottom-width: 1px;
        }

        #calc_table tr *, td * {
            border: 0 !important;
            text-align: center !important;
        }

        #calc_table th * {
            border: 0 !important;
            border-bottom: solid;
            border-bottom-width: 1px;
        }

        #calc_table_wrapper {
            display: inline-block;
            width: 50%;
            float: left;
        }

        .box > .pane-content {
            border-bottom-width: 1px !important;
        }

        {#remove all EPA css transitions for leaflet map#}
        div.mapNoTransition * {
            -o-transition-property: none !important;
            -moz-transition-property: none !important;
            -ms-transition-property: none !important;
            -webkit-transition-property: none !important;
            transition-property: none !important;
            transition: none !important;
        }

        .stream_info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        #stream_info h5 {
            margin: 0 0 5px;
            color: #777;
        }

        #stream_info_table table {
            width: 100%;
        }

        #stream_info_table td {
            font-size: 9px;
            border: none !important;
            background: rgba(255, 255, 255, 0.0);
            padding: 2px 3px !important;
        }

        {# Filter Buttons #}
        .filterButton {
            width: 100% !important;
            height: 30px !important;
            color: black;
            text-align: center !important;
            text-decoration: none !important;
            display: inline-block !important;
            font-size: 12px !important;
            border-radius: 12px !important;
            margin: 5px 0 !important;
            white-space: nowrap !important;
            padding: 0 !important;
            box-shadow: inset 0px 1px 0px #2ab7ec, 0px 1px 0px 0px #07526e, 0px 5px 5px #999 !important;
        }

        .filterButton:hover {
            box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        }

        .fish_filter {
            border-radius: 4px;
            padding: 2px 4px 4px 4px;
            background-color: transparent;
        {#            width: 11%;#} width: 9%;
            margin: 0 1px;
            display: inline-block;
        }

        #filter_field {
            font-size: 10px;
        }

        #filter_field_left {
            width: 50%;
            float: left;
            font-size: 10px;
        }

        #filter_field_right {
            width: 50%;
            float: right;
            font-size: 10px;
        }

        tr.filteredInFishTable td {
            background-color: #86C1FF !important;
        }

        {# Accordion css #}
        button.accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px 18px;
            width: 100%;
        {#            text-align: left;#} border: none;
            outline: none;
            margin: 0 !important;
            text-align: center;
        }

        button.accordion.active, button.accordion:hover {
            background-color: #ddd;
        }

        div.panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            text-align: center;
        {#        transition: max-height 0.2s ease-out;#}
        }

        button.accordion:after {
            content: '\02795'; /* Unicode character for "plus" sign (+) */
            font-size: 13px;
            color: #777;
            float: right;
            margin-left: 5px;
        }

        button.accordion.active:after {
            content: "\2796"; /* Unicode character for "minus" sign (-) */
        }

        td.details-control {
            background: url('/static_qed/pisces/images/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.details-control {
            background: url('/static_qed/pisces/images/details_close.png') no-repeat center center;
        }

        div.filtering {
            background-color: #0099FF;
        }

        {# flipswitch css #}
        .envelope_toggle {
            position: relative;
            width: 50%;
            height: 24px;
        {#            margin: 0px 0px 10px 5%;#} float: left;
        {#            display: block;#} -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .envelope_toggle-checkbox {
            display: none;
        }

        .envelope_toggle-label {
            display: block;
            overflow: hidden;
            cursor: pointer;
        {#            border: 2px solid #75A6D9;#} border-radius: 6px;
            width: 120px;
            box-shadow: 0px 2px 2px black;
            float: right;
            margin-right: 10px;
        }

        .envelope_toggle-inner {
            display: block;
            width: 200%;
            margin-left: -100%;
            transition: margin 0.3s ease-in 0s;
        }

        .envelope_toggle-inner:before, .envelope_toggle-inner:after {
            display: block;
            float: left;
            width: 50%;
            height: 24px;
            padding: 0;
            line-height: 24px;
            font-size: 12px;
            color: white;
            font-family: Trebuchet, Arial, sans-serif;
            font-weight: bold;
            box-sizing: border-box;
        }

        .envelope_toggle-inner:before {
            content: "Detailed Envelope";
            background-color: #86C1FF;
            text-align: center;
            color: #FFFFFF;
        }

        .envelope_toggle-inner:after {
            content: "Rounded Envelope";
        {#            padding-right: 10px;#} background-color: #EEEEEE;
            text-align: center;
            color: #999999;
        }

        .envelope_toggle-switch {
            display: block;
            width: 13px;
            margin: 5.5px;
            background: #FFFFFF;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 72px;
            border: 2px solid #75A6D9;
            border-radius: 6px;
            transition: all 0.3s ease-in 0s;
        }

        .envelope_toggle-checkbox:checked + .envelope_toggle-label .envelope_toggle-inner {
            margin-left: 0;
        }

        .envelope_toggle-checkbox:checked + .envelope_toggle-label .envelope_toggle-switch {
            right: 0px;
        }

        input[type="checkbox"]:checked + label::before {
            display: none;
        }

        input[type="checkbox"] + label::before {
            display: none;
        }

        .huc_calc_toggle {
            position: relative;
        {#            width: 50%;#} width: 100%;
            left: 45%;
            height: 24px;
        {#            margin: 0px 0px 10px 5%;#} float: left;
            display: block;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .huc_calc_toggle-checkbox, .huc_calc_toggle-checkbox {
            display: none;
        }

        .huc_calc_toggle-label {
            display: block;
            overflow: hidden;
            cursor: pointer;
            border-radius: 6px;
            width: 120px;
            box-shadow: 0px 2px 2px black;
            margin-left: 10px;
        }

        .huc_calc_toggle-inner {
            display: block;
            width: 200%;
            margin-left: -100%;
            transition: margin 0.3s ease-in 0s;
        }

        .huc_calc_toggle-inner:before, .huc_calc_toggle-inner:after {
            display: block;
            float: left;
            width: 50%;
            height: 24px;
            padding: 0;
            line-height: 24px;
            font-size: 12px;
            color: white;
            font-family: Trebuchet, Arial, sans-serif;
            font-weight: bold;
            box-sizing: border-box;
        }

        .huc_calc_toggle-inner:before {
            content: "Display Calculator";
            background-color: #86C1FF;
            text-align: center;
            color: black;
        }

        .huc_calc_toggle-inner:after {
            content: "Hide Calculator";
            background-color: #EEEEEE;
            text-align: center;
            color: black;
        }

        .huc_calc_toggle-switch {
            display: block;
            width: 13px;
            margin: 5.5px;
            background: #FFFFFF;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 72px;
            border: 2px solid #75A6D9;
            border-radius: 6px;
            transition: all 0.3s ease-in 0s;
        }

        .huc_calc_toggle-checkbox:checked + .huc_calc_toggle-label .huc_calc_toggle-inner {
            margin-left: 0;
        }

        .huc_calc_toggle-checkbox:checked + .huc_calc_toggle-label .huc_calc_toggle-switch {
            right: 0px;
        }

        div.ui-slider-horizontal {
            height: 0.3em !important;
        }

        span.ui-slider-handle {
            width: 0.8em !important;
            height: 0.8em !important;
        }

        div #hucFish {
            width: 45%;
            margin: 0 5px 0 55px;;
            display: inline-block;
            float: left;
        }

        div #abundance_calc {
            width: 45%;
            margin: 0 55px 0 5px;;
            display: inline-block;
            float: right;
        }

        input.biomass_reset_button {
            padding: 8px 16px !important;
            font-size: 14px;
        }

        {#    Loader    #}
        #loader {
            position: absolute;
            left: 50%;
            top: 85%;
            z-index: 999;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 100px;
            height: 100px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            transition: ease-in-out;
        }

        #loader_background {
            background-color: rgba(255, 255, 255, 0.5);
            z-index: 995;
            position: absolute;
            height: 625px;
            width: 100%;
        }

        td.tblCellEdit {

        }

        #calc_table input {
            padding: 0;
            font: inherit;
            width: 75%;
            display: inline;
            background: #98DED9;
        }


    </style>

    <script>

        var searchCount = 0;
        var selectedHuc;
        $(document).ready(function () {

            $('#fishTable').closest('div').hide();
            $('#filteredFishTable').closest('div').hide();
            $('#abundance_calc').closest('div').hide();
            $('#fish_filters').closest('div').hide();
            $('#envelope_toggle').closest('div').hide();
            $('#huc_calc_toggle').closest('div').hide();

            $('#selectHUC').on('change', function () {
                selectHUCs(this.value);
            });

            $('#accordion').on('click', expandFilter());

            $(document).on("click", ".filterButton", (function (event) {
                var input = $(this).closest('div');
                updateFilters(input);
                var filteredData = $('#filteredFishTable').DataTable().data();
                populateCalcTable(filteredData);
            }));

            $(document).on('input', "#filter_field", function (event) {
                var input = $(this.closest('div'));
                if (input.hasClass("filtering")) {
                    updateFilters(input);
                    var filteredData = $('#filteredFishTable').DataTable().data();
                    populateCalcTable(filteredData);
                }
            });

            $('#fishTable').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = $('#fishTable').DataTable().row(tr);
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(formatDetails(row.data())).show();
                    tr.addClass('shown');
                }
            });

            $('#myenvelope_toggle').on('click', function () {
                var button = $(this).closest('div');
                if (!button[0].classList.contains("detailed")) {
                    button.removeClass("rounded");
                    button.addClass("detailed");
                    // either make new call to server for detailed values or change columns used to populate table.
                }
                else {
                    button.removeClass("detailed");
                    button.addClass("rounded");
                    // either make new call to server for rounded values or change columns used to populate table.
                }
            });

            $('#in_huc_calc_toggle').on('click', function () {
                setTimeout(toggleCalculator(this), 1);
            });

            $('#biomass_weight').on('click', function () {
                document.getElementById('biomass_field').placeholder = "biomass in (kg)";
                document.getElementById('biomass_field').value = "";
                document.getElementById('biomass_field').title = "Enter a total biomass (kg) for the selected stream segment.";
            });

            $('#biomass_count').on('click', function () {
                document.getElementById('biomass_field').placeholder = "fish count";
                document.getElementById('biomass_field').value = "";
                document.getElementById('biomass_field').title = "Enter a total biomass (count) for the selected stream segment.";
            });

            $('#biomass_submit').on('click', function () {
                startLoad();
                setTimeout(startCalculation(), 1);
            });

            $('#biomass_reset').on('click', function () {
                var filteredData = $('#filteredFishTable').DataTable().data();
                populateCalcTable(filteredData);
            });

            $('#calc_table').on('click', 'td', function (e) {
                var v = this.innerHTML;
                if (!v.includes('<input') && ($(this).index() === 0 || $(this).index() === 2)) {
                    this.innerHTML = "<input id='tblCell' class='tblCellEdit' onfocus='this.value = this.value;' type='text' value='" + v + "'/>";
                }
                document.getElementById('tblCell').focus();

            });
            $('#calc_table').on('blur', 'td', function (e) {
                var v = this.childNodes[0].value;
                $('#calc_table').DataTable().cell(this).data(v).draw();
            });

        });

        function toggleCalculator(e) {
            var button = $(e).closest('div');
            if (!button[0].classList.contains("calculator")) {
                button.removeClass("fishHucTable");
                button.addClass("calculator");
                document.getElementById('fish_assemblage_estimator').style.float = 'left';
                document.getElementById('fish_assemblage_estimator').style.margin = '0px 5px 0px 55px';

                $('#hucFish').closest('div').hide();
                $('#abundance_calc').closest('div').show();
                // either make new call to server for detailed values or change columns used to populate table.
            }
            else {
                button.removeClass("calculator");
                button.addClass("fishHucTable");
                document.getElementById('fish_assemblage_estimator').style.float = 'right';
                document.getElementById('fish_assemblage_estimator').style.margin = '0px 55px 0px 5px';

                $('#abundance_calc').closest('div').hide();
                $('#hucFish').closest('div').show();
                // either make new call to server for rounded values or change columns used to populate table.
            }
        }

        function resetFilters() {
            $("#assemblage_filters");
            // Iterate over each filter and if hasClass(filtering) remove it and revert all values back to ""
        }

        function updateFilters(input) {
            var fishTable = $('#fishTable').DataTable();
            if (input.hasClass("filtering")) {
                input.removeClass('filtering');
            }
            else {
                input.addClass('filtering');
            }
            var filters = $("#assemblage_filters").find(".filtering");
            var resetData = fishTable.rows().data();
            populateFilteredFishTable(resetData);
            fishTable.rows().nodes().to$().removeClass('filteredInFishTable');
            if (filters.length !== 0) {
                var filteredTable = $('#filteredFishTable').DataTable();
                var inTable = Array.apply(null, {length: fishTable.rows().count()}).map(Function.call, Number);
                filters.map(function (index) {
                    var filterName = filters[index].firstElementChild.name.split('_');
                    var notInTable;
                    if (filterName[0] === "rarity") {
                        notInTable = filterRarity(Number(filterName[1]));      // TODO: Update n to column value for rarity from request
                    }
                    else {
                        notInTable = filterDataTable(Number(filterName[1]), Number(filterName[2]), filterName[0] + '_value');
                    }
                    for (var i = 0; i < notInTable.length; i++) {
                        var v = notInTable[i];
                        if (inTable.indexOf(v) !== -1) {
                            inTable.splice(inTable.indexOf(v), 1);
                        }
                    }
                });
                var filterData = filteredTable.rows(inTable).data();
                var genusIDs = filteredTable.cells(inTable, 6).data().toArray();
                fishTable.column(6, {order: 'index'}).data().filter(function (value, index) {
                    if (genusIDs.indexOf(value) >= 0) {
                        fishTable.row(index, {order: 'index'}).nodes().to$().addClass('filteredInFishTable');
                    }
                });
                populateFilteredFishTable(filterData);
                populateCalcTable(filterData);
            }
        }

        function filterRarity(columnN) {
            var filteredTable = $('#filteredFishTable').DataTable();
            var rarityRange = $('#rarity_value').val().split(' - ');
            var min = parseInt(rarityRange[0]);
            var max = parseInt(rarityRange[1]);
            var notInTable = [];
            var filterTable = filteredTable.column(columnN).data().filter(function (value, index) {
                if ((value >= min && value <= max) || value === null || isNaN(value)) {
                    return true;
                }
                else {
                    if (notInTable.indexOf(index) === -1) {
                        notInTable.push(index);
                    }
                    return false;
                }
            });
            return notInTable;
        }

        function filterDataTable(minColumn, maxColumn, compareValueName) {
            var filteredTable = $('#filteredFishTable').DataTable();
            var cValue = parseFloat(document.getElementsByClassName(compareValueName)[0].value);
            var notInTable = [];
            var filterTable = filteredTable.column(minColumn).data().filter(function (value, index) {
                if (value < cValue || isNaN(cValue) || value === null) {
                    return true;
                }
                else {
                    if (notInTable.indexOf(index) === -1) {
                        notInTable.push(index);
                    }
                    return false;
                }
            });
            var filterTable2 = filteredTable.column(maxColumn).data().filter(function (value, index) {
                if (value > cValue || isNaN(cValue) || value === null) {
                    return true;
                }
                else {
                    if (notInTable.indexOf(index) === -1) {
                        notInTable.push(index);
                    }
                    else {
                        notInTable.splice(notInTable.indexOf(index), 1);
                    }
                    return false;
                }
            });
            return notInTable;
        }

        function formatDetails(details) {
            return 'Mean Weight (g): ' + details[4] + '<br>' +
                'Rarity: ' + details[7] + '<br>' +
                'Stream Depth Range (cm): (' + details[20] + ' - ' + details[21] + ')<br>' +
                'Stream Width Range (m): (' + details[14] + ' - ' + details[15] + ')<br>' +
                'Stream Area Range (ha): (' + details[18] + ' - ' + details[19] + ')<br>' +
                'Stream Slope Range (%): (' + details[16] + ' - ' + details[16] + ')<br>' +
                'Stream TSS Range (mg/l): (' + details[24] + ' - ' + details[25] + ')<br>' +
                'Stream pH Range: (' + details[12] + ' - ' + details[13] + ')<br>' +
                'Stream Conductivity Range (uS/cm2): (' + details[10] + ' - ' + details[11] + ')<br>' +
                'Stream Dissolved Oxygen Range (% sat): (' + details[22] + ' - ' + details[23] + ')<br>';
        }

        function onStreamMapClick(e) {
            document.getElementById('table-focus').focus();
            $('#fish_filters').closest('div').show();
            $('#envelope_toggle').closest('div').show();
            $('#huc_calc_toggle').closest('div').show();
            setTimeout(getStreamData(e.latlng.lat, e.latlng.lng), 1);
            resetFilters();
            getFishData();
            {#            getTESTFishData();#}
        }

        function getStreamData(lat, lng) {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            var latitude = lat.toString();
            var longitude = lng.toString();
            $('#latVal').html(Number(latitude).toFixed(6));
            $('#lngVal').html(Number(longitude).toFixed(6));

            ptIndexParams = {
                'pGeometry': 'POINT(' + longitude + ' ' + latitude + ')'
                , 'pGeometryMod': 'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'pPointIndexingMethod': 'DISTANCE'
                , 'pPointIndexingMaxDist': 25
                , 'pOutputPathFlag': 'TRUE'
                , 'pReturnFlowlineGeomFlag': 'TRUE'
                , 'optOutCS': 'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'optOutPrettyPrint': 0
            };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                async: false,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    $('#comid').html(streamData.output.ary_flowlines[0].comid);
                    $('#huc8').html(streamData.output.ary_flowlines[0].wbd_huc12.substring(0, 8));
                    addStreamSeg(streamData);
                    return data;
                },
                error: function (jqXHR, status) {
                    $('#comId').html("Error attempting to get river data.");
                    return null;
                }
            });
        }

        function getFishData() {
            {#            var latitude = $('#latVal').html(Number(latitude));#}
            {#            var longitude = $('#lngVal').html(Number(longitude));#}
            {#            var ecoAJAX = JSON.stringify({"latitude": latitude, "longitude": longitude});#}
            {#            var ecoURL = "/pisces/rest/ecoregion";#}
            {#            $.ajax({#}
            {#                type: "POST",#}
            {#                url: ecoURL,#}
            {#                data: ecoAJAX,#}
            {#                crossDomain: true,#}
            {#                success: function (data) {#}
            {#                    var ecoData = JSON.parse(data);#}
            {#                    $('#ecoRegionId').html(ecoData.gid);#}
            {#                    $('#ecoRegionName').html(ecoData.region);#}
            {#                },#}
            {#                error: function (jqXHR, status) {#}
            {#                    $('#error_msg').html("Error attempting to get fish data.");#}
            {#                    return null;#}
            {#                }#}
            {#            });#}
            var huc8 = selectedHuc;
            $.ajax({
                type: "GET",
                url: "/pisces/rest/api/v1/fish/genera/hucs/" + huc8,
                crossDomain: true,
                success: function (data) {
                    populateFishTable(data["species"]);
                    var fishTableData = $('#fishTable').DataTable().rows().data();
                    populateFilteredFishTable(fishTableData);
                    populateCalcTable(fishTableData);
                },
                error: function (jqXHR, status) {
                    console.log("ERROR: ajax call failed. " + status);
                    $('#error_msg').html("Error: failed to get fish data for the selected huc.");
                    return null;
                }
            });
        }

        function getTESTFishData() {
            var ecoData = {"region": "Coastal Plains", "gid": 9};
            $('#ecoRegionId').html(ecoData.gid);
            $('#ecoRegionName').html(ecoData.region);

            var testFishData = {
                "huc": "04030101",
                "species": [
                    {
                        "species_id": 14,
                        "common_name": "alewife",
                        "genus": "Alosa",
                        "species": "pseudoharengus",
                        "mean_weight": 8.52,
                        "thinning": 0.568586,
                        "thin_adj": 0,
                        "rarity": 3,
                        "huc": "04030101",
                        "genusID": 6,
                        "cond_l": null,
                        "cond_u": null,
                        "ph_l": null,
                        "ph_u": null,
                        "width_l": null,
                        "width_u": null,
                        "slope_l": null,
                        "slope_u": null,
                        "area_l": null,
                        "area_u": null,
                        "depth_l": null,
                        "depth_u": null,
                        "do_l": null,
                        "do_u": null,
                        "tss_l": null,
                        "tss_u": null
                    },
                    {
                        "species_id": 19,
                        "common_name": "rock bass",
                        "genus": "Ambloplites",
                        "species": "rupestris",
                        "mean_weight": 83.9,
                        "thinning": 0.652222,
                        "thin_adj": 0.0141556,
                        "rarity": 3,
                        "huc": "04030101",
                        "genusID": 7,
                        "cond_l": 48,
                        "cond_u": 672,
                        "ph_l": 7.07,
                        "ph_u": 8.4,
                        "width_l": 3.54,
                        "width_u": 43.25,
                        "slope_l": 0.172,
                        "slope_u": 2.15,
                        "area_l": 1123.1,
                        "area_u": 86552.3,
                        "depth_l": 18.51,
                        "depth_u": 71.25,
                        "do_l": 45.0836,
                        "do_u": 97.3476,
                        "tss_l": 0.2,
                        "tss_u": 35.2
                    },
                    {
                        "species_id": 24,
                        "common_name": "black bullhead",
                        "genus": "Ameiurus",
                        "species": "melas",
                        "mean_weight": 31.8,
                        "thinning": 0.615341,
                        "thin_adj": -0.010577,
                        "rarity": 3,
                        "huc": "04030101",
                        "genusID": 9,
                        "cond_l": 44,
                        "cond_u": 714,
                        "ph_l": 6.62,
                        "ph_u": 8.32,
                        "width_l": 2.677,
                        "width_u": 41.3,
                        "slope_l": 0.2,
                        "slope_u": 1.89,
                        "area_l": 702.8,
                        "area_u": 168338,
                        "depth_l": 16.7475,
                        "depth_u": 70.34,
                        "do_l": 44.8378,
                        "do_u": 95.4602,
                        "tss_l": 0.0001,
                        "tss_u": 29.4
                    },
                    {
                        "species_id": 25,
                        "common_name": "yellow bullhead",
                        "genus": "Ameiurus",
                        "species": "natalis",
                        "mean_weight": 39.2,
                        "thinning": 0.623114,
                        "thin_adj": -0.0244977,
                        "rarity": 3,
                        "huc": "04030101",
                        "genusID": 9,
                        "cond_l": 44,
                        "cond_u": 714,
                        "ph_l": 6.62,
                        "ph_u": 8.32,
                        "width_l": 2.677,
                        "width_u": 41.3,
                        "slope_l": 0.2,
                        "slope_u": 1.89,
                        "area_l": 702.8,
                        "area_u": 168338,
                        "depth_l": 16.7475,
                        "depth_u": 70.34,
                        "do_l": 44.8378,
                        "do_u": 95.4602,
                        "tss_l": 0.0001,
                        "tss_u": 29.4
                    },
                    {
                        "species_id": 26,
                        "common_name": "brown bullhead",
                        "genus": "Ameiurus",
                        "species": "nebulosus",
                        "mean_weight": 21.9,
                        "thinning": 0.601723,
                        "thin_adj": -0.0180852,
                        "rarity": 6,
                        "huc": "04030101",
                        "genusID": 9,
                        "cond_l": 44,
                        "cond_u": 714,
                        "ph_l": 6.62,
                        "ph_u": 8.32,
                        "width_l": 2.677,
                        "width_u": 41.3,
                        "slope_l": 0.2,
                        "slope_u": 1.89,
                        "area_l": 702.8,
                        "area_u": 168338,
                        "depth_l": 16.7475,
                        "depth_u": 70.34,
                        "do_l": 44.8378,
                        "do_u": 95.4602,
                        "tss_l": 0.0001,
                        "tss_u": 29.4
                    }]
            };
            populateFishTable(testFishData["species"]);
            var fishTableData = $('#fishTable').DataTable().rows().data();
            populateFilteredFishTable(fishTableData);
            populateCalcTable(fishTableData);
        }

        function populateFishTable(data) {
            var fishArray = [];
            $('#fishTable').DataTable().destroy();
            $('#fishTable').empty();
            Object.keys(data).forEach(function (key) {
                fishArray.push(Object.values(data[key]));
            });
            var config = {
                data: fishArray,
                "columns": [
                    {
                        "class": "details-control",
                        "orderable": false,
                        "data": null,
                        "defaultContent": ""
                    },
                    {
                        data: 1,
                        title: "Common Name",
                        name: "common_name"
                    },
                    {
                        data: 2,
                        title: "Scientific Name",
                        name: "scientific_name"

                    },
                    {
                        data: 3,
                        title: "Genus",
                        name: "genus"
                    },
                    {
                        data: 7,
                        title: "Genus Id",
                        name: "genus_id"
                    },
                    {
                        data: 0,
                        title: "Species Id",
                        name: "species_id"

                    },
                    {
                        data: 4,
                        title: "Mean Weight",
                        name: "mean_weight"
                    },
                    {
                        data: 20,
                        title: "Depth Lower",
                        name: "depth_lower"
                    },
                    {
                        data: 21,
                        title: "Depth Upper",
                        name: "depth_upper"
                    },
                    {
                        data: 14,
                        title: "Width Lower",
                        name: "width_lower"
                    },
                    {
                        data: 15,
                        title: "Width Upper",
                        name: "width_upper"
                    },
                    {
                        data: 18,
                        title: "Area Lower",
                        name: "area_lower"
                    },
                    {
                        data: 19,
                        title: "Area Upper",
                        name: "area_upper"
                    },
                    {
                        data: 24,
                        title: "TSS Lower",
                        name: "tss_lower"
                    },
                    {
                        data: 25,
                        title: "TSS Upper",
                        name: "tss_upper"
                    },
                    {
                        data: 16,
                        title: "Slope Lower",
                        name: "slope_lower"
                    },
                    {
                        data: 17,
                        title: "Slope Upper",
                        name: "slope_upper"
                    },
                    {
                        data: 12,
                        title: "pH Lower",
                        name: "ph_lower"
                    },
                    {
                        data: 13,
                        title: "pH Upper",
                        name: "ph_upper"
                    },
                    {
                        data: 10,
                        title: "Conductivity Lower",
                        name: "conduct_lower"
                    },
                    {
                        data: 11,
                        title: "Conductivity Upper",
                        name: "conduct_upper"
                    },
                    {
                        data: 22,
                        title: "Dissolved Oxygen Lower",
                        name: "do_lower"
                    },
                    {
                        data: 23,
                        title: "Dissolved Oxygen Upper",
                        name: "do_upper"
                    },
                    {
                        data: 7,
                        title: "Rarity",
                        name: "rarity"
                    },
                    {
                        data: 5,
                        title: "&beta;",
                        name: "beta"
                    },
                    {
                        data: 6,
                        title: "&Delta;",
                        name: "delta"
                    }
                ],
                "columnDefs": [
                    {
                        "targets": [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25],
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return data + " " + row[3];
                        },
                        "targets": 2
                    }
                ],
                searching: false,
                "scrollY": 500,
                "scrollX": true,
                paging: false,
                bInfo: false,
                "order": [[1, 'asc']]

            };
            $('#fishTable').closest('div').show();
            $('#fishTable').DataTable(config);
        }

        function populateFilteredFishTable(data) {
            $('#filteredFishTable').DataTable().destroy();
            $('#filteredFishTable').empty();
            var config = {
                data: data,
                "columns": [
                    {
                        data: 1,
                        title: "Common Name",
                        name: "common_name"
                    },
                    {
                        data: 2,
                        title: "Scientific Name",
                        name: "scientific_name"

                    },
                    {
                        data: 3,
                        title: "Genus",
                        name: "genus"
                    },
                    {
                        data: 3,
                        title: "Genus",
                        name: "genus"
                    },
                    {
                        data: 7,
                        title: "Genus Id",
                        name: "genus_id"
                    },
                    {
                        data: 0,
                        title: "Species Id",
                        name: "species_id"

                    },
                    {
                        data: 4,
                        title: "Mean Weight",
                        name: "mean_weight"
                    },
                    {
                        data: 20,
                        title: "Depth Lower",
                        name: "depth_lower"
                    },
                    {
                        data: 21,
                        title: "Depth Upper",
                        name: "depth_upper"
                    },
                    {
                        data: 14,
                        title: "Width Lower",
                        name: "width_lower"
                    },
                    {
                        data: 15,
                        title: "Width Upper",
                        name: "width_upper"
                    },
                    {
                        data: 18,
                        title: "Area Lower",
                        name: "area_lower"
                    },
                    {
                        data: 19,
                        title: "Area Upper",
                        name: "area_upper"
                    },
                    {
                        data: 24,
                        title: "TSS Lower",
                        name: "tss_lower"
                    },
                    {
                        data: 25,
                        title: "TSS Upper",
                        name: "tss_upper"
                    },
                    {
                        data: 16,
                        title: "Slope Lower",
                        name: "slope_lower"
                    },
                    {
                        data: 17,
                        title: "Slope Upper",
                        name: "slope_upper"
                    },
                    {
                        data: 12,
                        title: "pH Lower",
                        name: "ph_lower"
                    },
                    {
                        data: 13,
                        title: "pH Upper",
                        name: "ph_upper"
                    },
                    {
                        data: 10,
                        title: "Conductivity Lower",
                        name: "conduct_lower"
                    },
                    {
                        data: 11,
                        title: "Conductivity Upper",
                        name: "conduct_upper"
                    },
                    {
                        data: 22,
                        title: "Dissolved Oxygen Lower",
                        name: "do_lower"
                    },
                    {
                        data: 23,
                        title: "Dissolved Oxygen Upper",
                        name: "do_upper"
                    },
                    {
                        data: 7,
                        title: "Rarity",
                        name: "rarity"
                    },
                    {
                        data: 5,
                        title: "&beta;",
                        name: "beta"
                    },
                    {
                        data: 6,
                        title: "&Delta;",
                        name: "delta"
                    }
                ],
                "columnDefs": [
                    {
                        "targets": [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25],
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return data + " " + row[3];
                        },
                        "targets": 1
                    },
                    {
                        "bSortable": false,
                        "aTargets": [0, 1]
                    }
                ],
                sorting: false,
                regex: true,
                searching: false,
                "scrollY": 500,
                "scrollX": true,
                paging: false,
                bInfo: false
            };
            $('#filteredFishTable').closest('div').show();
            $('#filteredFishTable').DataTable(config);
        }

        function populateCalcTable(data) {
            var d2 = JSON.parse(JSON.stringify(data));
            $('#calc_table').DataTable().destroy();
            $('#calc_table').empty();
            var config = {
                data: d2,
                "columns": [
                    {
                        data: 5,
                        title: "&beta;",
                        name: "beta"
                    },
                    {
                        data: 6,
                        title: "&Delta;",
                        name: "delta"
                    },
                    {
                        data: 4,
                        title: "W&#772;",
                        name: "mean_weight"
                    },
                    {
                        data: 26,
                        title: "Biomass(kg)",
                        name: "biomass",
                        defaultContent: ''
                    },
                    {
                        data: 27,
                        title: "Count",
                        name: "count",
                        defaultContent: ''
                    }
                ],
                "columnDefs": [
                    {
                        "bSortable": false,
                        "aTargets": [0, 1, 2, 3, 4]
                    }
                ],
                sorting: false,
                regex: true,
                searching: false,
                "scrollY": 500,
                "scrollX": true,
                paging: false,
                bInfo: false
            };
            $('#calc_table').DataTable(config);
        }

        function addStreamSeg(streamData) {
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function (c) {
                return c.reverse();
            });
            var huc8 = getStreamHuc(streamData.output.ary_flowlines[0].wbd_huc12);
            var huc8geom;
            if (huc8[0][0] < 0) {
                huc8geom = huc8.map(function (c) {
                    return c.reverse();
                });
            }
            else {
                huc8geom = huc8;
            }

            if (map.hasLayer(selectedStream)) {
                map.removeLayer(selectedStream);
                map.removeLayer(streamHuc);
            }

            selectedStream = L.polyline(latlon, {
                color: '#02bfe7',
                weight: 5,
                opacity: 0.9,
                lineJoin: 'round'
            }).addTo(map);
            streamHuc = L.polygon(huc8geom, {
                color: 'white',
                weight: 2,
                opacity: 0.9,
                fillColor: '#9ecae1',
                fillOpacity: 0.3
            }).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function getStreamHuc(hucID) {
            var huc8 = null;
            L.geoJSON(huc8s, {
                filter: function (feature, layer) {
                    if (feature.properties.HUC_CODE === hucID.substring(0, 8)) {
                        huc8 = feature.geometry.coordinates[0];
                    }
                }
            });
            selectedHuc = hucID.substring(0, 8);
            return huc8;
        }

        $(function () {
            $("#rarity_range").slider({
                range: true,
                min: 1,
                max: 10,
                values: [1, 10],
                slide: function (event, ui) {
                    $("#rarity_value").val(ui.values[0] + " - " + ui.values[1]);
                }
            });
            $("#rarity_value").val($("#rarity_range").slider("values", 0) +
                " - " + $("#rarity_range").slider("values", 1));

        });

        {# Accordion JS #}

        function expandFilter() {
            var acc = document.getElementsByClassName("accordion");
            var i;

            for (i = 0; i < acc.length; i++) {
                acc[i].onclick = function () {
                    this.classList.toggle("active");
                    var panel = this.nextElementSibling;
                    if (panel.style.maxHeight) {
                        panel.style.maxHeight = null;
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                }
            }
            return false;
        }

        function startCalculation() {
            var test = document.getElementById('biomass_weight');
            if (document.getElementById('biomass_weight').checked) {
                calculateAbundanceFromBiomass(10000);
            }
            else {
                calculateAbundanceFromCount(Number($('#biomass_field').val()));
            }
            endLoad();
        }

        function calculateAbundanceFromCount(c) {
            var fishList = $('#calc_table').DataTable();
            var beta = fishList.column(0).data();
            var delta = fishList.column(1).data();
            var mW = fishList.column(2).data();

            // Calculating abundance for each fish.
            var A = mW.map(function (W, i) {
                return Math.pow(W, -(beta[i] - delta[i]));
            });
            // Sum of abundance
            var sumA = A.reduce(function (pv, cv) {
                return pv + cv;
            }, 0);

            // Relative abundance
            var RA = A.map(function (a) {
                return a / sumA;
            });

            // Species Count
            var count = RA.map(function (ra) {
                return Math.round(ra * c);
            });

            // Biomass for each species
            var BM = count.map(function (cnt, i) {
                return Number(((cnt * mW[i]) / 1000).toFixed(1));
            });

            var fishData = fishList.data().map(function (f, i) {
                if (searchCount > 0) {
                    f.pop();
                    f.pop();
                }
                f.push(BM[i]);
                f.push(count[i]);
                return f;
            });
            searchCount++;
            populateCalcTable(fishData);
        }

        function calculateAbundanceFromBiomass(c) {
            var B = Number($('#biomass_field').val());

            var fishList = $('#calc_table').DataTable();
            var beta = fishList.column(0).data();
            var delta = fishList.column(1).data();
            var mW = fishList.column(2).data();

            // Calculating abundance for each fish.
            var A = mW.map(function (W, i) {
                return Math.pow(W, -(beta[i] - delta[i]));
            });
            // Sum of abundance
            var sumA = A.reduce(function (pv, cv) {
                return pv + cv;
            }, 0);

            // Relative abundance
            var RA = A.map(function (a) {
                return a / sumA;
            });

            var E = 0; // ERROR value;
            while (E < 0.95 || E > 1.05) {
                // Species Count
                var count = RA.map(function (ra) {
                    return Math.round(ra * c);
                });

                var BM = count.map(function (cnt, i) {
                    return Number(((cnt * mW[i]) / 1000).toFixed(1));
                });
                // Sun of biomass
                var sumBM = BM.reduce(function (pv, cv) {
                    return pv + cv;
                }, 0);

                // Adjustment of ERROR. Count is modified by the ERROR value.
                E = B / sumBM;
                c = E * c;
            }
            var fishData = fishList.data().map(function (f, i) {
                if (searchCount > 0) {
                    f.pop();
                    f.pop();
                }
                f.push(BM[i]);
                f.push(count[i]);
                return f;
            });
            searchCount++;
            populateCalcTable(fishData);
        }

        function startLoad() {
            document.getElementById("loader").style.display = "block";
            document.getElementById("loader_background").style.display = "block";
        }

        function endLoad() {
            document.getElementById("loader").style.display = "none";
            document.getElementById("loader_background").style.display = "none";
        }

    </script>
</head>
<body>
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">
        <div id="loader" style="display:none;"></div>
        <div id="loader_background" style="display:none"></div>

        <!--- content div -->
        <div class="col-md-10">
            <div class="box multi news">
                <div class="pane-content" id="mapDiv">
                    <p><strong>Zoom in and select a stream</strong> on the map to view a list of fish species associated
                        with the stream segment.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)" title="Base Map">
                            <option value="Imagery">Imagery</option>
                            <option value="Streets">Streets</option>
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                </div>
                <br class="row" id="streamData">
                <div id="fish_filters" style="display:none;">
                    <button class="accordion">Fish Assemblage Filters</button>
                    <div class="panel" id="assemblage_filters" style="overflow: hidden;">
                        <div class="fish_filter">
                            <input id="rarity_filter" type="button" name="rarity_23" value="Rarity" class="filterButton"
                                   align="center" title="Filter fish by rarity.">
                            <input title="Rarity Range" type="text" id="rarity_value" readonly
                                   style="border:0; color:black; font-weight:bold; font-size: 10px; text-align: center; background-color: transparent;height: 10px;vertical-align: super;">
                            <div id="rarity_range" style="width: 75%; margin: -7px 0 3px 15%;"></div>
                        </div>
                        <div class="fish_filter">
                            <input id="depth_filter" type="button" name="depth_7_8" value="Depth" class="filterButton"
                                   align="center" title="Filter fish by stream depth."><br>
                            <input type="text" id="filter_field" class="depth_value" placeholder="(cm)"
                                   title="Enter a value in centimeters.">
                        </div>
                        <div class="fish_filter">
                            <input id="width_filter" type="button" name="width_9_10" value="Width" class="filterButton"
                                   align="center" title="Filter fish by stream width."><br>
                            <input type="text" id="filter_field" class="width_value" placeholder="(m)"
                                   title="Enter a value in meters.">
                        </div>
                        <div class="fish_filter">
                            <input id="area_filter" type="button" name="area_11_12" value="Area" class="filterButton"
                                   align="center" title="Filter fish by stream drainage area."><br>
                            <input type="text" id="filter_field" class="area_value" placeholder="(ha)"
                                   title="Enter a value in hectares.">
                        </div>
                        <div class="fish_filter">
                            <input id="slope_filter" type="button" name="slope_15_16" value="Slope" class="filterButton"
                                   align="center" title="Filter fish by stream slope."><br>
                            <input type="text" id="filter_field" class="slope_value" placeholder="(%)"
                                   title="Enter a value as a percent grade.">
                        </div>
                        <div class="fish_filter">
                            <input id="tss_filter" type="button" name="tss_13_14" value="TSS" class="filterButton"
                                   align="center" title="Filter fish by stream tss."><br>
                            <input type="text" id="filter_field" class="tss_value" placeholder="(mg/l)"
                                   title="Enter a value in milligrams per liter.">
                        </div>
                        <div class="fish_filter">
                            <input id="ph_filter" type="button" name="ph_17_18" value="pH" class="filterButton"
                                   align="center" title="Filter fish by stream pH."><br>
                            <input type="text" id="filter_field" class="ph_value" placeholder="(SU)"
                                   title="Enter a value in standard units.">
                        </div>
                        <div class="fish_filter">
                            <input id="cond_filter" type="button" name="cond_19_20" value="Conductivity"
                                   class="filterButton" align="center" title="Filter fish by stream conductivity."><br>
                            <input type="text" id="filter_field" class="cond_value" placeholder="(uS/cm2)"
                                   title="Enter a value in micro-Siemens per square centimeter.">
                        </div>
                        <div class="fish_filter">
                            <input id="do_filter" type="button" name="do_21_22" value="Dissolved Oxygen"
                                   class="filterButton" align="center"
                                   title="Filter fish by stream dissolved oxygen."><br>
                            <input type="text" id="filter_field" class="do_value" placeholder="(% sat)"
                                   title="Enter a value as percentage.">
                        </div>
                    </div>
                </div>
                <br>
                <div class="envelope_toggle detailed" id="envelope_toggle" style="display:none;">
                    <input type="checkbox" name="envelope_toggle" class="envelope_toggle-checkbox"
                           id="myenvelope_toggle"
                           checked>
                    <label class="envelope_toggle-label" for="myenvelope_toggle" title="Toggle Envelope Type"
                           style="display:none;">
                        <span class="envelope_toggle-inner"></span>
                        {#                        <span class="envelope_toggle-switch"></span>#}
                    </label>
                </div>
                <div class="huc_calc_toggle huc_table" id="huc_calc_toggle" style="display:none;">
                    <input type="checkbox" name="huc_calc_toggle" class="huc_calc_toggle-checkbox"
                           id="in_huc_calc_toggle"
                           checked>
                    <label class="huc_calc_toggle-label" for="in_huc_calc_toggle" title="Toggle Abundance Calculator">
                        <span class="huc_calc_toggle-inner"></span>
                        {#                        <span class="envelope_toggle-switch"></span>#}
                    </label>
                </div>
                <div class="col-md-12">
                    <div id="error_msg"></div>
                    <div id="hucFish" style="display:none;">
                        <h4 style="text-align: center; width: 100%">Fish in Selected HUC</h4>
                        <table id="fishTable" class="display compact hover" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Scientific Name</th>
                                {#                                <th>Species</th>#}
                                <th>Genus</th>
                                <th>Genus ID</th>
                                <th>Species ID</th>
                                <th>Max Size</th>
                                <th>Depth - Lower</th>
                                <th>Depth - Upper</th>
                                <th>Width - Lower</th>
                                <th>Width - Upper</th>
                                <th>Area - Lower</th>
                                <th>Area - Upper</th>
                                <th>TSS - Lower</th>
                                <th>TSS - Upper</th>
                                <th>Slope - Lower</th>
                                <th>Slope - Upper</th>
                                <th>HUC ID</th>
                                <th>PH - Lower</th>
                                <th>PH - Upper</th>
                                <th>Cond - Lower</th>
                                <th>Cond - Upper</th>
                                <th>DO - Lower</th>
                                <th>DO - Upper</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="abundance_calc" style="display:none;">
                        <h4 style="text-align: center; width: 100%">Abundance Calculator</h4>
                        <table id="calc_table" class="display compact hover" cellspacing="0"
                               style="float: left;width:95%; margin: 0 3px;"
                               title="Click on &beta; and W&#772; to modify values.">
                            <thead>
                            <tr>
                                <td>&beta;</td>
                                <td>&Delta;</td>
                                <td>W&#772;</td>
                                <td>Count</td>
                                <td>Biomass</td>
                            </tr>
                            </thead>
                        </table>
                        <div style="float:right; width: 50%;">
                            <div style="float:left; width: 55%;">
                                <input type="text" id="biomass_field" class="biomass_value" placeholder="biomass (kg)"
                                       style="float:left; width:90%; font-size: 12px;"
                                       title="Enter a total biomass (kg) for the selected stream segment.">
                            </div>
                            <div style="float:right; width: 45%;">
                                <input type="radio" id="biomass_weight" class="biomass_weight_value" name="biomass"
                                       value="weight" checked>
                                <label for="biomass_weight"
                                       style="display: inline-block; font-size: 12px; margin: 2px 10px; float: left;">By
                                    weight</label>
                                <input type="radio" id="biomass_count" class="biomass_count_value" name="biomass"
                                       value="count">
                                <label for="biomass_count"
                                       style=" display: inline-block; font-size: 12px; margin: 2px 10px; float: left;">By
                                    count</label>
                            </div>
                            <div style="float: left;">
                                <input style="margin: 25px 10px 10px 10px;" type="button" id="biomass_submit"
                                       class="biomass_button"
                                       name="biomass_button"
                                       value="Calculate" title="Calculate fish assemblage biomass.">
                                <input style="margin: 25px 10px 10px 10px;" type="button" id="biomass_reset"
                                       class="biomass_reset_button"
                                       name="biomass_reset_button"
                                       value="Reset" title="Reset &beta; and W&#772; coefficients.">

                            </div>
                        </div>
                    </div>
                    <div id="fish_assemblage_estimator"
                         style="width:45%; margin:0px 55px 0px 5px; display: none; float: right; left:0;">
                        <h4 style="text-align: center; width: 100%">Filtered Fish Assemblage</h4>
                        <table id="filteredFishTable" class="display compact hover" cellspacing="0" width="100%"
                               style="padding: 0 2px; margin: 0 2px;">
                            <thead>
                            <tr>
                                <th>Common Name</th>
                                <th>Scientific Name</th>
                                <th>Count</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="table-focus" tabindex="-1"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script> // initialize the map

document.getElementById("map").focus();

var map = L.map('map').setView([40.265306, -98.623725], 5);
// sets variable for selected stream
var selectedStream;
// sets the Huc for the selected stream
var streamHuc;

// load a tile layer
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: ['a', 'b', 'c']
}).addTo(map);


// -------------- BASE MAP code -------------- //

var layer = L.esri.basemapLayer('Imagery').addTo(map);
var layerLabels;

function setBasemap(basemap) {
    if (layer) {
        map.removeLayer(layer);
    }

    layer = L.esri.basemapLayer(basemap);

    map.addLayer(layer);

    if (layerLabels) {
        map.removeLayer(layerLabels);
    }

    if (basemap === 'ShadedRelief'
        || basemap === 'Imagery'
        || basemap === 'Terrain'
        {#        || basemap === 'Topographic'#}
    ) {
        layerLabels = L.esri.basemapLayer(basemap + 'Labels');
        map.addLayer(layerLabels);
    }
}

function changeBasemap(basemaps) {
    var basemap = basemaps.value;
    setBasemap(basemap);
    addStreams();
}

// ------------ STREAM NETWORK code ------------- //

//L.control.layers(streamNetwork).addTo(map);
function addStreams() {
    L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
        layers: 4,
        format: 'image/png',
        minZoom: 0,
        maxZoom: 18,
        transparent: true
    }).addTo(map);
}

map.on('click', onStreamMapClick);
addStreams();
// --------------- INFO WINDOW code -------------- //

var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'stream_info');
    this.update();
    return this._div;
};

info.update = function (props) {
    this._div.innerHTML = '<h5>Stream Segment Info</h5>' +
        '<table id="stream_info_table" style="margin-bottom: 0px !important; background: none !important;"> ' +
        '<tr><td>Latitude:</td> <td id="latVal"></td></tr>' +
        '<tr><td>Longitude:</td><td id="lngVal"></td></tr>' +
        '<tr><td>Com ID:</td><td id="comid"></td></tr>' +
        '<tr><td>EcoRegion Name:</td><td id="ecoRegionName"></td></tr>' +
        '<tr style="display:none;"><td>EcoRegion ID:</td><td id=ecoRegionId></td></tr>' +
        '<tr><td>WBD HUC8:</td><td id="huc8"></td></tr>';
};

info.addTo(map);

</script>
</body>

</html>