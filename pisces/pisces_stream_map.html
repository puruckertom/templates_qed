<style>
    #map {
        width: 100%;
        height: 450px;
    }

    #streamData {
        padding: 10px;
        width: 100%;
    }

    {#datatables font size#}
    th {
        font-size: 12px;
    }

    td {
        font-size: 11px;
    }

    .table {
        border-bottom: 0 !important;
    }

    #fishTable tr *, td * {
        border: 0 !important;
    }

    #fishTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    .box > .pane-content {
        border-bottom-width: 1px !important;
    }

    {#remove all EPA css transitions for leaflet map#}
    div.mapNoTransition * {
        -o-transition-property: none !important;
        -moz-transition-property: none !important;
        -ms-transition-property: none !important;
        -webkit-transition-property: none !important;
        transition-property: none !important;
        transition: none !important;
    }

    .stream_info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    #stream_info h5 {
        margin: 0 0 5px;
        color: #777;
    }

    #stream_info_table table {
        width: 100%;
    }

    #stream_info_table td {
        font-size: 9px;
        border: none !important;
        background: rgba(255, 255, 255, 0.0);
        padding: 2px 3px !important;
    }

    {# Filter Buttons #}
    .filterButton {
        width: 100% !important;
        height: 30px !important;
        color: black;
        text-align: center !important;
        text-decoration: none !important;
        display: inline-block !important;
        font-size: 12px !important;
        border-radius: 12px !important;
        margin: 5px 0 !important;
        white-space: nowrap !important;
        padding: 0 !important;
    }

    .filterButton:hover {
        box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
    }

    .fish_filter {
        border-radius: 4px;
        padding: 2px 4px 4px 4px;
    {#        float: left;#} background-color: transparent;
        width: 11%;
        margin: 0 1px;
        display: table-cell;
    }

    #filter_field_left {
        width: 50%;
        float: left;
        font-size: 10px;
    }

    #filter_field_right {
        width: 50%;
        float: right;
        font-size: 10px;
    }

    {# Accordion css #}
    button.accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
    {#        transition: 0.4s;#} margin: 0 !important;
    }

    button.accordion.active, button.accordion:hover {
        background-color: #ddd;
    }

    div.panel {
        padding: 0 18px;
        background-color: white;
        max-height: 0;
        overflow: hidden;
    {#        transition: max-height 0.2s ease-out;#}
    }

    button.accordion:after {
        content: '\02795'; /* Unicode character for "plus" sign (+) */
        font-size: 13px;
        color: #777;
        float: right;
        margin-left: 5px;
    }

    button.accordion.active:after {
        content: "\2796"; /* Unicode character for "minus" sign (-) */
    }


</style>

<head>

    <!-- jquery -->
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <!-- datatables import -->
    <link rel="stylesheet"
          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js -->
    <script src="/static_qed/pisces/scripts/waterslayer.js"></script>
    <script src="/static_qed/pisces/scripts/pisces_datatable.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>

    <script>
        $(document).ready(function () {

            $('#fishTable').closest('table').hide();

            $("#selectHUC").on('change', function () {
                selectHUCs(this.value);
            });

            $("#accordion").click(expandFilter());
            $(document).on("click", ".filterButton",(function(event){
                filterButtonClick(event.target.id);
            }));
        });


        function onStreamMapClick(e) {
            getStreamData(e.latlng.lat, e.latlng.lng);
            //getFishData();
            getTESTFishData();
        }

        function getStreamData(lat, lng) {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            var latitude = lat.toString();
            var longitude = lng.toString();
            $('#latVal').html(Number(latitude).toFixed(6));
            $('#lngVal').html(Number(longitude).toFixed(6));

            ptIndexParams = {
                'pGeometry': 'POINT(' + longitude + ' ' + latitude + ')'
                , 'pGeometryMod': 'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'pPointIndexingMethod': 'DISTANCE'
                , 'pPointIndexingMaxDist': 25
                , 'pOutputPathFlag': 'TRUE'
                , 'pReturnFlowlineGeomFlag': 'TRUE'
                , 'optOutCS': 'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'optOutPrettyPrint': 0
            };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    $('#comid').html(streamData.output.ary_flowlines[0].comid);
                    $('#huc8').html(streamData.output.ary_flowlines[0].wbd_huc12.substring(0,8));
                    addStreamSeg(streamData);
                    return data;
                },
                error: function (jqXHR, status) {
                    $('#comId').html("Error attempting to get river data.");
                    return null;
                }
            });
        }

        function getFishData() {
            var ecoAJAX = JSON.stringify({"latitude": latitude, "longitude": longitude});
            var ecoURL = "/pisces/rest/ecoregion";
            $.ajax({
                type: "POST",
                url: ecoURL,
                data: ecoAJAX,
                crossDomain: true,
                success: function (data) {
                    var ecoData = JSON.parse(data);
                    $('#ecoRegionId').html(ecoData.gid);
                    $('#ecoRegionName').html(ecoData.region);
                },
                error: function (jqXHR, status) {
                    $('#error_msg').html("Error attempting to get ecoRegion data.");
                    return null;
                }
            });

            var huc8 = JSON.stringify([document.getElementById('#huc8').value]);
            $.ajax({
                type: "POST",
                url: "/pisces/rest/fishproperies",
                data: huc8,
                crossDomain: true,

                success: function (data) {
                    populateFishTable(data)
                },
                error: function (jqXHR, status) {
                    $('#error_msg').html("Error: failed to get fish data for the selected huc.");
                    return null;
                }
            });
        }

        function getTESTFishData() {
            var ecoData = {"region": "Coastal Plains", "gid": 9};
            $('#ecoRegionId').html(ecoData.gid);
            $('#ecoRegionName').html(ecoData.region);

            var testFishData = {
                "cognatus": {
                    "depth_l": 10.09,
                    "tss_l": 0.0001,
                    "area_l": 208.1,
                    "area_u": 25890.0,
                    "common_name": "slimy sculpin",
                    "genusID": 41,
                    "depth_u": 59.3727,
                    "species": "cognatus",
                    "tss_u": 22.2,
                    "species_id": 137,
                    "max_Size": 12.0,
                    "slope_u": 3.45,
                    "huc": "04030101",
                    "ph_l": 6.65,
                    "ph_u": 8.35,
                    "slope_l": 0.255,
                    "width_l": 2.025,
                    "genus": "Cottus",
                    "cond_l": 23.6,
                    "do_l": 47.5254,
                    "do_u": 95.1819,
                    "width_u": 18.51,
                    "cond_u": 534.0
                },
                "zenithicus": {
                    "depth_l": null,
                    "tss_l": null,
                    "area_l": null,
                    "area_u": null,
                    "common_name": "shortjaw cisco",
                    "genusID": 40,
                    "depth_u": null,
                    "species": "zenithicus",
                    "tss_u": null,
                    "species_id": 126,
                    "max_Size": 40.0,
                    "slope_u": null,
                    "huc": "04030101",
                    "ph_l": null,
                    "ph_u": null,
                    "slope_l": null,
                    "width_l": null,
                    "genus": "Coregonus",
                    "cond_l": null,
                    "do_l": null,
                    "do_u": null,
                    "width_u": null,
                    "cond_u": null
                },
                "heterolepis": {
                    "depth_l": 16.27,
                    "tss_l": 0.8,
                    "area_l": 595.8,
                    "area_u": 77418.0,
                    "common_name": "blacknose shiner",
                    "genusID": 134,
                    "depth_u": 66.32,
                    "species": "heterolepis",
                    "tss_u": 34.0,
                    "species_id": 706,
                    "max_Size": 10.0,
                    "slope_u": 2.0,
                    "huc": "04030101",
                    "ph_l": 7.1,
                    "ph_u": 8.43,
                    "slope_l": 0.2,
                    "width_l": 2.467,
                    "genus": "Notropis",
                    "cond_l": 46.0,
                    "do_l": 42.1327,
                    "do_u": 99.3147,
                    "width_u": 27.4545,
                    "cond_u": 883.0
                },
                "elongatus": {
                    "depth_l": 13.48,
                    "tss_l": 0.4,
                    "area_l": 129.4,
                    "area_u": 10614.0,
                    "common_name": "redside dace",
                    "genusID": 39,
                    "depth_u": 61.52,
                    "species": "elongatus",
                    "tss_u": 31.4,
                    "species_id": 109,
                    "max_Size": 12.0,
                    "slope_u": 3.25,
                    "huc": "04030101",
                    "ph_l": 6.56,
                    "ph_u": 8.18,
                    "slope_l": 0.1889,
                    "width_l": 1.25,
                    "genus": "Clinostomus",
                    "cond_l": 22.8,
                    "do_l": 49.0757,
                    "do_u": 90.2983,
                    "width_u": 14.25,
                    "cond_u": 496.0
                },
                "hankinsoni": {
                    "depth_l": null,
                    "tss_l": null,
                    "area_l": 1782.9,
                    "area_u": 279035.0,
                    "common_name": "brassy minnow",
                    "genusID": 86,
                    "depth_u": null,
                    "species": "hankinsoni",
                    "tss_u": null,
                    "species_id": 493,
                    "max_Size": 10.0,
                    "slope_u": null,
                    "huc": "04030101",
                    "ph_l": 6.81,
                    "ph_u": 8.13,
                    "slope_l": null,
                    "width_l": 4.02,
                    "genus": "Hybognathus",
                    "cond_l": 89.0,
                    "do_l": 24.8836,
                    "do_u": 82.509,
                    "width_u": 62.7273,
                    "cond_u": 388.4
                },
                "nigrum": {
                    "depth_l": 13.17,
                    "tss_l": 0.8,
                    "area_l": 213.6,
                    "area_u": 34914.5,
                    "common_name": "johnny darter",
                    "genusID": 69,
                    "depth_u": 63.7386,
                    "species": "nigrum",
                    "tss_u": 34.0,
                    "species_id": 352,
                    "max_Size": 7.0,
                    "slope_u": 2.44,
                    "huc": "04030101",
                    "ph_l": 6.85,
                    "ph_u": 8.36,
                    "slope_l": 0.155,
                    "width_l": 1.635,
                    "genus": "Etheostoma",
                    "cond_l": 43.0,
                    "do_l": 45.0836,
                    "do_u": 99.3147,
                    "width_u": 21.6364,
                    "cond_u": 714.0
                },
                "umbratilis": {
                    "depth_l": 23.68,
                    "tss_l": 2.5,
                    "area_l": 1997.9,
                    "area_u": 63266.0,
                    "common_name": "redfin shiner",
                    "genusID": 112,
                    "depth_u": 62.04,
                    "species": "umbratilis",
                    "tss_u": 15.8,
                    "species_id": 591,
                    "max_Size": 8.5,
                    "slope_u": 2.0,
                    "huc": "04030101",
                    "ph_l": 6.83,
                    "ph_u": 8.22,
                    "slope_l": 0.06,
                    "width_l": 4.4355,
                    "genus": "Lythrurus",
                    "cond_l": 36.7,
                    "do_l": 48.2465,
                    "do_u": 84.8443,
                    "width_u": 16.88,
                    "cond_u": 340.7
                }
            };
            populateFishTable(testFishData);
        }

        function populateFishTable(data) {
            var fishArray = [];
            Object.keys(data).forEach(function (key) {
                fishArray.push(Object.values(data[key]));
            });
            $('#fishTable').closest('table').show();
            $('#fishTable').dataTable({
                data: fishArray,
                "scrollX": true,
                "scrollY": true,
                "columns": [
                    {data: 4},
                    {data: 7},
                    {#                    {data: 17},#}
                    {#                    {data: 5},#}
                    {#                    {data: 9},#}
                    {#                    {data: 10},#}
                    {#                    {data: 0},#}
                    {#                    {data: 6},#}
                    {#                    {data: 16},#}
                    {#                    {data: 21},#}
                    {#                    {data: 2},#}
                    {#                    {data: 3},#}
                    {#                    {data: 1},#}
                    {#                    {data: 8},#}
                    {#                    {data: 15},#}
                    {#                    {data: 11},#}
                    {#                    {data: 12},#}
                    {#                    {data: 13},#}
                    {#                    {data: 14},#}
                    {#                    {data: 18},#}
                    {#                    {data: 22},#}
                    {#                    {data: 19},#}
                    {#                    {data: 20}#}
                ],
                "columnDefs": [
                    {
                        "render": function (data, type, row) {
                            return row[17] + ' ' + data;
                        },
                        "targets": 1
                    }
                ],
                searching: false,
                paging: false,
                bInfo: false

            });
        }

        function addStreamSeg(streamData) {
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function (c) {
                return c.reverse();
            });
            var huc8 = getStreamHuc(streamData.output.ary_flowlines[0].wbd_huc12);
            var huc8geom;
            if (huc8[0][0] < 0) {
                huc8geom = huc8.map(function (c) {
                    return c.reverse();
                });
            }
            else {
                huc8geom = huc8;
            }

            if (map.hasLayer(selectedStream)) {
                map.removeLayer(selectedStream);
                map.removeLayer(streamHuc);
            }

            selectedStream = L.polyline(latlon, {
                color: '#02bfe7',
                weight: 8,
                opacity: 0.9,
                lineJoin: 'round'
            }).addTo(map);
            streamHuc = L.polygon(huc8geom, {
                color: 'white',
                weight: 2,
                opacity: 0.9,
                fillColor: '#9ecae1',
                fillOpacity: 0.3
            }).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function getStreamHuc(hucID) {
            var huc8 = null;
            L.geoJSON(huc8s, {
                filter: function (feature, layer) {
                    if (feature.properties.HUC_CODE === hucID.substring(0, 8)) {
                        huc8 = feature.geometry.coordinates[0];
                    }
                }
            });
            return huc8;
        }

    </script>
    <script>

        {# Filter functionality #}
        function filterButtonClick(id) {
            var selectedFilter = document.getElementById(id).closest('div');
            if (selectedFilter.style.backgroundColor !== 'rgb(0, 153, 255)') {
                selectedFilter.style.backgroundColor = '#0099FF';
                {# based on id, apply appropriate filtering of the dataTable contents. #}
            }
            else {
                selectedFilter.style.backgroundColor = 'transparent';
                {# undo filtering of the appropriate id #}
            }
            return false;
        }

        {# Accordion JS #}

        function expandFilter() {
            var acc = document.getElementsByClassName("accordion");
            var i;

            for (i = 0; i < acc.length; i++) {
                acc[i].onclick = function () {
                    this.classList.toggle("active");
                    var panel = this.nextElementSibling;
                    if (panel.style.maxHeight) {
                        panel.style.maxHeight = null;
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                }
            }
            return false;
        }
    </script>
</head>
<body>
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">

        <!--- content div -->
        <div class="col-md-10">
            <div class="box multi news">
                <div class="pane-content" id="mapDiv">
                    <p><strong>Zoom in and select a stream</strong> on the map to view a list of fish species associated
                        with the stream segment.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)">
                            <option value="Topographic">Topographic</option>
                            <option value="Streets">Streets</option>
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="Imagery">Imagery</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                </div>
                <br class="row" id="streamData">
                <button class="accordion" >Fish Assemblage Filters</button>
                <div class="panel" id="assemblage_filters" style="overflow: hidden;">

                    <div class="fish_filter">
                        <input id="depth_filter" type="button" name="depth" value="Depth" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="depth_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="depth_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input  id="width_filter" type="button" name="width" value="Width" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="width_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="width_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="area_filter" type="button" name="area" value="Area" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="area_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="area_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="slope_filter" type="button" name="slope" value="Slope" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="slope_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="slope_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="tss_filter" type="button" name="tss" value="TSS" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="tss_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="tss_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="ph_filter" type="button" name="ph" value="pH" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="ph_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="ph_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="cond_filter" type="button" name="cond" value="Conductivity" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="cond_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="depth_max" placeholder="(max)">
                    </div>
                    <div class="fish_filter">
                        <input id="do_filter" type="button" name="dis_o" value="Dissolved Oxygen" class="filterButton" align="center"><br>
                        <input type="text" id="filter_field_left" name="do_min" placeholder="(min)">
                        <input type="text" id="filter_field_right" name="do_max" placeholder="(max)">
                    </div>
                </div>
                <br>
                <div class="col-md-12">
                    <div id="error_msg"></div>
                    <h4 style="text-align: center; width: 30%" align="left">Fish in Selected HUC</h4>
                    <table id="fishTable" class="display compact hover" cellspacing="0" width="30%"
                           align="left">
                        <thead>
                        <tr>
                            <th>Common Name</th>
                            <th>Scientific Name</th>
                            {#                                    <th>Species</th>#}
                            {#                                    <th>Genus</th>#}
                            {#                                    <th>Genus ID</th>#}
                            {#                                    <th>Species ID</th>#}
                            {#                                    <th>Max Size</th>#}
                            {#                                    <th>Depth - Lower</th>#}
                            {#                                    <th>Depth - Upper</th>#}
                            {#                                    <th>Width - Lower</th>#}
                            {#                                    <th>Width - Upper</th>#}
                            {#                                    <th>Area - Lower</th>#}
                            {#                                    <th>Area - Upper</th>#}
                            {#                                    <th>TSS - Lower</th>#}
                            {#                                    <th>TSS - Upper</th>#}
                            {#                                    <th>Slope - Lower</th>#}
                            {#                                    <th>Slope - Upper</th>#}
                            {#                                    <th>HUC ID</th>#}
                            {#                                    <th>PH - Lower</th>#}
                            {#                                    <th>PH - Upper</th>#}
                            {#                                    <th>Cond - Lower</th>#}
                            {#                                    <th>Cond - Upper</th>#}
                            {#                                    <th>DO - Lower</th>#}
                            {#                                    <th>DO - Upper</th>#}
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script> // initialize the map
var map = L.map('map').setView([33.95, -83.38], 11);
// sets variable for selected stream
var selectedStream;
// sets the Huc for the selected stream
var streamHuc;

// load a tile layer
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: ['a', 'b', 'c']
}).addTo(map);


// -------------- BASE MAP code -------------- //

var layer = L.esri.basemapLayer('Imagery').addTo(map);
var layerLabels;

function setBasemap(basemap) {
    if (layer) {
        map.removeLayer(layer);
    }

    layer = L.esri.basemapLayer(basemap);

    map.addLayer(layer);

    if (layerLabels) {
        map.removeLayer(layerLabels);
    }

    if (basemap === 'ShadedRelief'
        || basemap === 'Imagery'
        || basemap === 'Terrain'
        || basemap === 'Topographic'
    ) {
        layerLabels = L.esri.basemapLayer(basemap + 'Labels');
        map.addLayer(layerLabels);
    }
}

function changeBasemap(basemaps) {
    var basemap = basemaps.value;
    setBasemap(basemap);
    addStreams();
}

// ------------ STREAM NETWORK code ------------- //

//L.control.layers(streamNetwork).addTo(map);
function addStreams() {
    L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
        layers: 4,
        format: 'image/png',
        minZoom: 0,
        maxZoom: 18,
        transparent: true
    }).addTo(map);
}

map.on('click', onStreamMapClick);
addStreams();
// --------------- INFO WINDOW code -------------- //

var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'stream_info');
    this.update();
    return this._div;
};

info.update = function (props) {
    this._div.innerHTML = '<h5>Stream Segment Info</h5>' +
        '<table id="stream_info_table" style="margin-bottom: 0px !important; background: none !important;"> ' +
        '<tr><td>Latitude:</td> <td id="latVal"></td></tr>' +
        '<tr><td>Longitude:</td><td id="lngVal"></td></tr>' +
        '<tr><td>Com ID:</td><td id="comid"></td></tr>' +
        '<tr><td>EcoRegion Name:</td><td id="ecoRegionName"></td></tr>' +
        '<td>WBD HUC8:</td><td id="huc8"></td>';
};

info.addTo(map);

</script>
</body>

</html>