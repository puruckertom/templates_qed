<style>
    #map {
        width: 100%;
        height: 450px;
    }

    #basemaps-wrapper {
        background: white;
        padding: 10px;
        width: 100%;
    }

    {#datatables font size#}
    th {
        font-size: 12px;
    }

    td {
        font-size: 11px;
    }

    {#remove all EPA css transitions for leaflet map#}
    div.mapNoTransition * {
        -o-transition-property: none !important;
        -moz-transition-property: none !important;
        -ms-transition-property: none !important;
        -webkit-transition-property: none !important;
        transition-property: none !important;
        transition: none !important;
    }

    div.fishSearch {
        display: inline-block;
        float: right;
        border-style: solid;
        border-width: 1px;
        width: 28%;
        max-height: 450px;
        margin: 1px 1px;
    {#        padding: 10px 10px#} padding: 1.3529em 1em;
    }

    input.fishSearchBox {
        font-size: 12px;
        float: left;
        display: inline-block;
        width: 75%;
        height: 22px;
        border-radius: 3px 0 0 3px !important;

    }

    input.fishSearchButton {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB2aWV3Qm94PSIwIDAgMjg5LjEyMjIyIDI4OC4yOTYwOCIgaGVpZ2h0PSIxMnB4IiB3aWR0aD0iMTJweCI+DQo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjYzLjQzMTIsLTM4OS42MzEyNCkiPg0KPHBhdGggc3Ryb2tlLXdpZHRoPSI5Ljc1NjE3MzEzIiBmaWxsPSIjRkZGIiBkPSJNMjk1LjkzODk5LDQyMi4wODZjLTQzLjI3Mjk5LDQzLjI3Mi00My4zNzg5OSwxMTQuMTU5LTAuMTA1OTgsMTU3LjQzMjAxLDM2LjY2Mjk5LDM2LjY2MzAyLDkzLjIwMTk5LDQyLjI1LDEzNS45MjA5OSwxNi43NjU5OWw3Ni4zNDM5OSw3NC4yMzQ5OGMxMC41MDY5OSwxMC4xOTgsMjcuMDg0OTksOS44MjEwNSwzNy4xMTY5Ny0wLjg0Mzk5LDEwLjAzMzAyLTEwLjY2NDk4LDkuNzcwMDItMjcuNDQ1OTktMC43Mzc5Ny0zNy42NDM5OGwtNzUuMTgyOTgtNzIuODY0MDJjMjYuMzYwOTktNDIuODQ2OTgsMjEuMDA3OTktMTAwLjA0NDk4LTE2LjAyODAyLTEzNy4wODA5OS00My4yNzI5OC00My4yNzMwMS0xMTQuMDU0OTktNDMuMjczMDEtMTU3LjMyNywwem0zMS43Mzg5OSwzMS43MzkwMWMyNi4xMDIwMi0yNi4xMDIwMiw2Ny43NDYwMy0yNi4xMDIwMiw5My44NDgwMiwwLDI2LjEwMTk5LDI2LjEwMTk5LDI2LjEwMTk5LDY3Ljc0NTk4LDAsOTMuODQ3OTYtMjYuMTAxOTksMjYuMTAyMDYtNjcuNzQ2LDI2LjEwMjA2LTkzLjg0ODAyLDAtMjYuMTAxOTktMjYuMTAxOTktMjYuMTAxOTktNjcuNzQ1OTcsMC05My44NDc5NnoiLz4NCjwvZz4NCjwvc3ZnPg==");
        background-color: #02bfe7;
        background-repeat: no-repeat;
        background-size: 10px 10px;
        background-position: 50%;
        border-color: #02bfe7;
        float: left;
        display: inline-block;
        width: 10px;
        height: 22px;
        margin-left: 0 !important;
        border-radius: 0 3px 3px 0 !important;
    }

    #fishTable thead * {
        font-size: 10px;
    }

    #fishTable tbody {
        cursor: pointer;
    }

    #fishTable thead *, tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #fishTable tr:hover td {
        background-color: #02bfe7;
    }

    tr.selected_fish td {
        background-color: #6baed6 !important;
    }

    div.fishDetails {
        display: inline-block;
        font-size: 12px;
        padding: 5px 5px;
        margin-top: 10px;
        width: 70%;
    }

    div.fishDetails p {
        background-color: #DBF1FF;
        padding: 0 5px;
        border-width: 1px;
        border-color: black;
        border-style: solid;
    }

</style>

<head>

    <!-- jquery -->
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <!-- datatables import -->
    <link rel="stylesheet"
          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- local js -->
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>
    <script src="/static_qed/pisces/scripts/pisces_datatable.js"></script>

</head>

<body>
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">

        <!-- leaflet import -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.1/esri-leaflet-geocoder.css">
        <script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.1/esri-leaflet-geocoder.js"></script>


        <!--- content div -->
        <div class="col-md-10">
            <div class="box multi news">
                <div class="pane-content" id="mapDiv" style="display: inline-block; float:left; width: 70%">
                    <p><strong>Select a HUC 8 watershed</strong> on the map to view a list of fish species associated
                        with the area.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <!-- basemap wrapper -->
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)" title="Base Map">
                            <option value="Topographic">Topographic</option>
                            <option value="Imagery">Imagery</option>
                            <option value="Streets">Streets</option>
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                    <br>
                </div>
                <div class="fishSearch">
                    <div>
                        <input class="fishSearchBox" type="text" name="fish_search"
                               placeholder="Search for fish species...">
                        <input class="fishSearchButton" type="button">
                    </div>
                    <div class="fishTable">
                        <h5 align="center">Fish in selected HUC</h5>
                        <table id="fishTable" class="display compact hover" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th>Common Name</th>
                                <th>Scientific Name</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div id="selectedFishTable" class="fishDetails"></div>
                <div id="fish_weight_length" style="float:right; width:25%; font-size:12px; margin-top:10px">
                    <h4>Weight - Length Calculator</h4>
                    <input style="float:left; width:75%; margin: 10px 10px;" type="text" id="fish_weight" title="Fish Weight" placeholder="Fish weight...">
                    <input style="float:left; width:75%; margin: 10px 10px;" type="text" id="fish_length" title="Fish Length" placeholder="Fish length...">
                </div>
            </div>
        </div>
        <div id="focusDetails" tabindex="-1"></div>

        <script>

            $(document).ready(function () {
                $('#fishTable').on('click', 'tr', function () {
                    $('#fishTable').DataTable().rows().nodes().to$().removeClass('selected_fish');
                    var cName = $('#fishTable').DataTable().row(this).node().children[0].innerHTML;
                    var sName = $('#fishTable').DataTable().row(this).node().children[1].innerHTML;
                    var details = $('#fishTable').DataTable().row(this).data();
                    setFishDetails(cName, sName, details);
                    $('#fishTable').DataTable().row(this).nodes().to$().addClass('selected_fish')
                    $('#fish_weight_length').show();

                    // Make ajax call to get all hucs where selected fish is present. (new function)
                    // Highlight all returned hucs
                    // Set map bounds to bounds of new hucs selected.
                });
            });

            $('#fish_weight_length').hide();
            $('.fishTable').closest('div').hide();

            //style HUC 8 polygon
            function getColor(d) {
                return d > 110 ? '#084594' :
                    d > 86 ? '#2171b5' :
                        d > 63 ? '#4292c6' :
                            d > 41 ? '#6baed6' :
                                d > 20 ? '#9ecae1' :
                                    d > -1 ? '#c6dbef' :
                                        'red';
            }

            //style HUC 8 polygon cont.
            function hucStyle(feature) {
                return {
                    fillColor: getColor(feature.properties.NumbSpc),
                    weight: .5,
                    opacity: 0.9,
                    color: 'black',
                    fillOpacity: 0.5
                };
            }

            //style selected HUC 8 polygon
            function selectHUCs(hucs) {
                resetHUCLayer();
                //  properties of highlighted HUC
                huc8Layer.eachLayer(function (layer) {
                    if (hucs === layer.feature.properties.HUC_CODE)
                        layer.setStyle({color: 'black', weight: 2.5, fillColor: '#02bfe7', fillOpacity: 0.6});
                    if (hucs === layer.feature.properties.HUC_CODE)
                        layer.bringToFront();
                });
            }

            //get fish json data for selected HUC
            function getHUCFishData(hucs) {
                var url = "http://127.0.0.1:8000/fishhucs/" + hucs;
                $.ajax({
                    type: "GET",
                    url: url,
                    dataType: "json",
                    success: function (data, status, jqXHR) {
                        populateFishTable(data);
                        return data;
                    },
                    error: function (jqXHR, status) {
                        return null;
                    }
                })
            }

            //get fish json data for selected HUC
            function resetHUCLayer() {
                huc8Layer.eachLayer(function (layer) {
                    huc8Layer.resetStyle(layer);
                });
                {#                document.getElementsByClassName('#selectedFishTable').innerHTML = "";#}

            }

            var currentHUC = null;

            function onEachFeature(feature, layer) {
                layer.on('click', function (e) {

                    if (this.currentHUC !== feature.properties.HUC_CODE || this.currentHUC === null) {
                        this.currentHUC = feature.properties.HUC_CODE;
                        selectHUCs(feature.properties.HUC_CODE);
                        //var data = getHUCFishData(feature.properties.HUC_CODE);
                        getFishDataonMapClick(feature.properties.HUC_CODE);
                    }
                    else {
                        $('.fishTable').closest('div').hide();
                        $('#fish_weight_length').hide();
                        document.getElementById('selectedFishTable').innerHTML = null;
                        resetHUCLayer();
                        this.currentHUC = null;
                    }
                });
            }

            // initialize the map
            var map = L.map('map', {renderer: L.svg({padding: 100})}).setView([33.95, -83.38], 8);

            // load basemap
            L.esri.basemapLayer('Topographic')
                .addTo(map);

            // load huc watershed boundaries
            var huc8Layer = L.geoJson(huc8s, {
                style: hucStyle,
                onEachFeature: onEachFeature
            }).addTo(map);

            //basemap selection toolbar
            var layerESRI = L.esri.basemapLayer('Imagery');
            var layerLabels;

            function setBasemap(basemap) {
                if (layerESRI) {
                    map.removeLayer(layerESRI);
                }
                layerESRI = L.esri.basemapLayer(basemap);
                map.addLayer(layerESRI);
                if (layerLabels) {
                    map.removeLayer(layerLabels);
                }
                if (basemap === 'ShadedRelief' || basemap === 'Imagery' || basemap === 'Terrain') {
                    layerLabels = L.esri.basemapLayer(basemap + 'Labels');
                    map.addLayer(layerLabels);
                }
            }

            function changeBasemap(basemaps) {
                var basemap = basemaps.value;
                setBasemap(basemap);
            }

            // -------- FISH Functions ---------- //


            function getFishDataonMapClick(huc8) {
                //var data = getFishData(huc8);
                var data = getTESTFishData();
            }

            function getFishData(huc8) {

                $.ajax({
                    type: "POST",
                    url: "/pisces/rest/fishproperies",
                    data: huc8,
                    crossDomain: true,

                    success: function (data) {
                        populateFishTable(data)
                    },
                    error: function (jqXHR, status) {
                        $('#error_msg').html("Error: failed to get fish data for the selected huc.");
                        return null;
                    }
                });
            }

            function getTESTFishData() {
                var testFishData = {
                    "cognatus": {
                        "depth_l": 10.09,
                        "tss_l": 0.0001,
                        "area_l": 208.1,
                        "area_u": 25890.0,
                        "common_name": "slimy sculpin",
                        "genusID": 41,
                        "depth_u": 59.3727,
                        "species": "cognatus",
                        "tss_u": 22.2,
                        "species_id": 137,
                        "max_Size": 12.0,
                        "slope_u": 3.45,
                        "huc": "04030101",
                        "ph_l": 6.65,
                        "ph_u": 8.35,
                        "slope_l": 0.255,
                        "width_l": 2.025,
                        "genus": "Cottus",
                        "cond_l": 23.6,
                        "do_l": 47.5254,
                        "do_u": 95.1819,
                        "width_u": 18.51,
                        "cond_u": 534.0
                    },
                    "zenithicus": {
                        "depth_l": null,
                        "tss_l": null,
                        "area_l": null,
                        "area_u": null,
                        "common_name": "shortjaw cisco",
                        "genusID": 40,
                        "depth_u": null,
                        "species": "zenithicus",
                        "tss_u": null,
                        "species_id": 126,
                        "max_Size": 40.0,
                        "slope_u": null,
                        "huc": "04030101",
                        "ph_l": null,
                        "ph_u": null,
                        "slope_l": null,
                        "width_l": null,
                        "genus": "Coregonus",
                        "cond_l": null,
                        "do_l": null,
                        "do_u": null,
                        "width_u": null,
                        "cond_u": null
                    },
                    "heterolepis": {
                        "depth_l": 16.27,
                        "tss_l": 0.8,
                        "area_l": 595.8,
                        "area_u": 77418.0,
                        "common_name": "blacknose shiner",
                        "genusID": 134,
                        "depth_u": 66.32,
                        "species": "heterolepis",
                        "tss_u": 34.0,
                        "species_id": 706,
                        "max_Size": 10.0,
                        "slope_u": 2.0,
                        "huc": "04030101",
                        "ph_l": 7.1,
                        "ph_u": 8.43,
                        "slope_l": 0.2,
                        "width_l": 2.467,
                        "genus": "Notropis",
                        "cond_l": 46.0,
                        "do_l": 42.1327,
                        "do_u": 99.3147,
                        "width_u": 27.4545,
                        "cond_u": 883.0
                    },
                    "elongatus": {
                        "depth_l": 13.48,
                        "tss_l": 0.4,
                        "area_l": 129.4,
                        "area_u": 10614.0,
                        "common_name": "redside dace",
                        "genusID": 39,
                        "depth_u": 61.52,
                        "species": "elongatus",
                        "tss_u": 31.4,
                        "species_id": 109,
                        "max_Size": 12.0,
                        "slope_u": 3.25,
                        "huc": "04030101",
                        "ph_l": 6.56,
                        "ph_u": 8.18,
                        "slope_l": 0.1889,
                        "width_l": 1.25,
                        "genus": "Clinostomus",
                        "cond_l": 22.8,
                        "do_l": 49.0757,
                        "do_u": 90.2983,
                        "width_u": 14.25,
                        "cond_u": 496.0
                    },
                    "hankinsoni": {
                        "depth_l": null,
                        "tss_l": null,
                        "area_l": 1782.9,
                        "area_u": 279035.0,
                        "common_name": "brassy minnow",
                        "genusID": 86,
                        "depth_u": null,
                        "species": "hankinsoni",
                        "tss_u": null,
                        "species_id": 493,
                        "max_Size": 10.0,
                        "slope_u": null,
                        "huc": "04030101",
                        "ph_l": 6.81,
                        "ph_u": 8.13,
                        "slope_l": null,
                        "width_l": 4.02,
                        "genus": "Hybognathus",
                        "cond_l": 89.0,
                        "do_l": 24.8836,
                        "do_u": 82.509,
                        "width_u": 62.7273,
                        "cond_u": 388.4
                    },
                    "nigrum": {
                        "depth_l": 13.17,
                        "tss_l": 0.8,
                        "area_l": 213.6,
                        "area_u": 34914.5,
                        "common_name": "johnny darter",
                        "genusID": 69,
                        "depth_u": 63.7386,
                        "species": "nigrum",
                        "tss_u": 34.0,
                        "species_id": 352,
                        "max_Size": 7.0,
                        "slope_u": 2.44,
                        "huc": "04030101",
                        "ph_l": 6.85,
                        "ph_u": 8.36,
                        "slope_l": 0.155,
                        "width_l": 1.635,
                        "genus": "Etheostoma",
                        "cond_l": 43.0,
                        "do_l": 45.0836,
                        "do_u": 99.3147,
                        "width_u": 21.6364,
                        "cond_u": 714.0
                    },
                    "umbratilis": {
                        "depth_l": 23.68,
                        "tss_l": 2.5,
                        "area_l": 1997.9,
                        "area_u": 63266.0,
                        "common_name": "redfin shiner",
                        "genusID": 112,
                        "depth_u": 62.04,
                        "species": "umbratilis",
                        "tss_u": 15.8,
                        "species_id": 591,
                        "max_Size": 8.5,
                        "slope_u": 2.0,
                        "huc": "04030101",
                        "ph_l": 6.83,
                        "ph_u": 8.22,
                        "slope_l": 0.06,
                        "width_l": 4.4355,
                        "genus": "Lythrurus",
                        "cond_l": 36.7,
                        "do_l": 48.2465,
                        "do_u": 84.8443,
                        "width_u": 16.88,
                        "cond_u": 340.7
                    }
                };
                populateFishTable(testFishData);
            }

            function populateFishTable(data) {
                var fishArray = [];
                $('#fishTable').DataTable().destroy();
                $('#fishTable').empty();
                Object.keys(data).forEach(function (key) {
                    fishArray.push(Object.values(data[key]));
                });
                var config = {
                    data: fishArray,
                    "columns": [
                        {
                            data: 4,
                            title: "Common Name",
                            name: "common_name"
                        },
                        {
                            data: 7,
                            title: "Scientific Name",
                            name: "scientific_name"
                        }
                    ],
                    "columnDefs": [
                        {
                            "render": function (data, type, row) {
                                return row[17] + ' ' + data;
                            },
                            "targets": 1
                        }
                    ],
                    scrollX: true,
                    searching: false,
                    paging: false,
                    bInfo: false,
                    "order": [[0, 'asc']]
                };
                $('.fishTable').closest('div').show();
                $('#fishTable').DataTable(config);
            }

            function setFishDetails(cName, sName, details) {
                var d = document.getElementById('selectedFishTable');
                document.getElementById('focusDetails').focus();
                d.innerHTML = '<h4>' + capitalize_Words(cName) + '</h4>' +
                    '<h5>' + capitalize_Words(sName) + '</h5><p>' +
                    'Max Size (cm): ' + (details[10] || 'N/A ') + '<br>' +
                    'Stream Depth Range (cm): ' + (details[0] || 'N/A ') + ' - ' + (details[6] || 'N/A ') + '<br>' +
                    'Stream Width Range (m): ' + (details[16] || 'N/A ') + ' - ' + (details[21] || 'N/A ') + '<br>' +
                    'Stream Area Range (ha): ' + (details[2] || 'N/A ') + ' - ' + (details[3] || 'N/A ') + '<br>' +
                    'Stream Slope Range (%): ' + (details[15]|| 'N/A ') + ' - ' + (details[11] || 'N/A ') + '<br>' +
                    'Stream TSS Range (mg/l): ' + (details[1] || 'N/A ') + ' - ' + (details[8] || 'N/A ') + '<br>' +
                    'Stream pH Range: ' + (details[13] || 'N/A ') + ' - ' + ( details[14] || 'N/A ') + '<br>' +
                    'Stream Conductivity Range (uS/cm2): ' + (details[18] || 'N/A ') + ' - ' + (details[22] || 'N/A ') + '<br>' +
                    'Stream Dissolved Oxygen Range (%): ' + (details[19] || 'N/A ') + ' - ' + (details[20] || 'N/A ') + '<br></p>';
            }

            function capitalize_Words(str) {
                return str.replace(/\w\S*/g, function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }
        </script>

    </div>
</div>

</body>
</html>