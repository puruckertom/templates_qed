
<style>
    #map {
        width: 100%;
        height: 450px;
    }

    #basemaps-wrapper {
        background: white;
        padding: 10px;
        width: 100%;
    }

    {#datatables font size#}
    th {
        font-size: 12px;
    }

    td {
        font-size: 11px;
    }

    .table {
        border-bottom: 0 !important;
    }

    #acuteFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #acuteFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    #chronicFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #chronicFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    #overallFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #overallFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    .box > .pane-content {
        border-bottom-width: 1px !important;
    }

    {#remove all EPA css transitions for leaflet map#}
    div.mapNoTransition * {
        -o-transition-property: none !important;
        -moz-transition-property: none !important;
        -ms-transition-property: none !important;
        -webkit-transition-property: none !important;
        transition-property: none !important;
        transition: none !important;
    }

    .stream_info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    #stream_info h5 {
        margin: 0 0 5px;
        color: #777;
    }

    #stream_info_table table {
        width: 100%;
    }

    #stream_info_table td {
        font-size: 9px;
        border: none !important;
        background: rgba(255, 255, 255, 0.0);
        padding: 2px 3px !important;
    }

    #pestTable table > tbody > tr > td {
        border-style: none;
    }

    #pestTable table {
        border: black 1px solid;
    }

    #tbl_col {
        background-color: lightgray;
    }

</style>

<head>

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <!-- datatables import -->
    {#    <link rel="stylesheet"#}
    {#          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">#}
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js stream lines, watershed bnds, -->
    <script src="/static_qed/sam/testExposureOutput.js"></script>
    <script src="/static_qed/sam/testExposureOutput.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>


    <script>

        //  create placeholder global comid variable
        var comid = null;
        console.log(comid);
        $(document).ready(function () {
            $('#csvSave').on("click", saveTableAsCSV);
        });

        function onStreamMapClick(e) {
            getStreamData(e.latlng.lat, e.latlng.lng);
        }


        //ajax call using lat long for stream data
        function getStreamData(lat, lng) {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            var latitude = lat.toString();
            var longitude = lng.toString();
            $('#latVal').html(Number(latitude).toFixed(6));
            $('#lngVal').html(Number(longitude).toFixed(6));

            var ptIndexParams = {
                'pGeometry': 'POINT(' + longitude + ' ' + latitude + ')'
                , 'pGeometryMod': 'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'pPointIndexingMethod': 'DISTANCE'
                , 'pPointIndexingMaxDist': 25
                , 'pOutputPathFlag': 'TRUE'
                , 'pReturnFlowlineGeomFlag': 'TRUE'
                , 'optOutCS': 'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'optOutPrettyPrint': 0
            };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    var selectedComid = streamData.output.ary_flowlines[0].comid;
                    var wantedData = outputData.features.filter(function (i) {
                        return (i.properties.COMID == selectedComid);
                    });
                    $('#boxid').html(selectedComid);
                    addStreamSeg(streamData, selectedComid);
                    setTimeout(populateFilteredTable(wantedData[0].properties), 300);
                    return false;
                },
                error: function (jqXHR, status) {
                    $('#boxid').html("Error attempting to get river data.");
                    return false;
                }
            });
        }

        <!--- add stream to map -->
        function addStreamSeg(streamData, comid) {
            console.log(comid);
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function (c) {
                return c.reverse();
            });
            if (map.hasLayer(selectedStream)) {
                map.removeLayer(selectedStream);
            }
            selectedStream = L.polyline(latlon, {
                color: '#02bfe7',
                weight: 8,
                opacity: 0.9,
                lineJoin: 'round'
            }).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function populateFilteredTable(data) {
            //convert object into an array of objects
            var dataHtml = "<h4 style=\"text-align: center; width: 100%\">Probability of Pesticide Concentration Exceedance</h4>" +
                    "<table id='samWatershedTable'>" +
                    "<thead style='display:none;'><th></th><th></th><th></th><th></th><th></th><th></th></thead>" +
                    "<tbody>" +
                    "<tr><td id='tbl_col'>Acute Em Fish</td><td>" + data["acute_em_fish"] + "</td>" +
                    "<td id='tbl_col'>Chronic Em Fish</td><td>" + data["chronic_em_fish"] + "</td>" +
                    "<td id='tbl_col'>Overall Em Fish</td><td>" + data["overall_em_fish"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Em Inv</td><td>" + data["acute_em_inv"] + "</td>" +
                    "<td id='tbl_col'>Chronic Em Inv</td><td>" + data["chronic_em_inv"] + "</td>" +
                    "<td id='tbl_col'>Overall Em Inv</td><td>" + data["overall_em_inv"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Fw Fish</td><td>" + data["acute_fw_fish"] + "</td>" +
                    "<td id='tbl_col'>Chronic Fw Fish</td><td>" + data["chronic_fw_fish"] + "</td>" +
                    "<td id='tbl_col'>Overall Fw Fish</td><td>" + data["overall_fw_fish"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Fw Inv</td><td>" + data["acute_fw_inv"] + "</td>" +
                    "<td id='tbl_col'>Chronic Fw Inv</td><td>" + data["chronic_fw_inv"] + "</td>" +
                    "<td id='tbl_col'>Overall Fw Inv</td><td>" + data["overall_fw_inv"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Human</td><td>" + data["acute_human"] + "</td>" +
                    "<td id='tbl_col'>Chronic Human</td><td>" + data["chronic_human"] + "</td>" +
                    "<td id='tbl_col'>Overall Human</td><td>" + data["overall_human"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Nonvasc Plant</td><td>" + data["acute_nonvasc_plant"] + "</td>" +
                    "<td id='tbl_col'>Chronic Nonvasc Plant</td><td>" + data["chronic_nonvasc_plant"] + "</td>" +
                    "<td id='tbl_col'>Overall Nonvasc Plant</td><td>" + data["overall_nonvasc_plant"] + "</td></tr>" +
                    "<tr><td id='tbl_col'>Acute Vasc Plant</td><td>" + data["acute_vasc_plant"] + "</td>" +
                    "<td id='tbl_col'>Chronic Vasc Plant</td><td>" + data["chronic_vasc_plant"] + "</td>" +
                    "<td id='tbl_col'>Overall Vasc Plant</td><td>" + data["overall_vasc_plant"] + "</td></tr>" +
                    "</tbody>" +
                    "</table>";
            $('#pestTable').html(dataHtml);
            $('#saveTable').show();
        }

        function saveTableAsCSV() {
            var data = "";
            var config = {
                sorting: false,
                searching: false,
                paging: false,
                bInfo: false
            };
            var dt = $('#samWatershedTable').dataTable(config);
            dt.rows().data().map(function (r) {
                data += r.toString() + "\n";
            });
            var mainHeader = "SAM Pesticide Probabilities \n";
            var metaHeader = "COMID, Latitude, Longitude \n";
            var metadata = $('#boxid').html() + ", " + $('#latVal').html() + ", " + $('#lngVal').html() + "\n";
            var fileName = "SAM_pesticide_" + comid;
            var pom = document.createElement('a');
            pom.setAttribute('href', 'data:data:text/csv;charset=utf-8,' + encodeURIComponent(mainHeader + "\n" + metaHeader + metadata + "\n" + data));
            pom.setAttribute('download', fileName + '.csv');
            if (document.createEvent) {
                var event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
            }
            else {
                pom.click();
            }
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>

</head>


<body>
<!--- content div -->
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">
        <div class="col-md-10">
            <div class="box multi news">

                <!--- map and info -->
                <div class="pane-content" id="mapDiv">
                    <p><strong>Select a stream</strong> on the map to view the local probability of pesticide exceedance
                        for various populations.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)">
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="Topographic">Topographic</option>
                            <option value="Streets">Streets</option>
                            <option value="Imagery">Imagery</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                        <select name="fieldselect" id="fieldselect" onChange=refreshOutput(fieldselect)>
                            <option value="acute_human">Human health DWLOC (acute)</option>
                            <option value="acute_fw_fish">Freshwater Fish (acute)</option>
                            <option value="chronic_fw_fish">Freshwater Fish (chronic)</option>
                            <option value="acute_fw_inv">Freshwater Invertebrate (acute)</option>
                            <option value="chronic_fw_inv">Freshwater Invertebrate (chronic)</option>
                            <option value="acute_em_fish">Estuarine/Marine Fish (acute)</option>
                            <option value="chronic_em_fish">Estuarine/Marine Fish (chronic)</option>
                            <option value="acute_em_inv">Estuarine/Marine Invertebrate (acute)</option>
                            <option value="chronic_em_inv">Estuarine/Marine Invertebrate (chronic)</option>
                            <option value="acute_nonvasc_plant">Aquatic nonvascular plant (acute)</option>
                        </select>
                    </div>
                </div>

                <br>

                <div id="pest">
                    <div id="pestTable">
                        <table id="samWatershedTable"></table>
                    </div>
                </div>
                <div id="saveTable" style="display:none;">
                    <input id="csvSave" name="save" type="submit" value="Save to CSV"
                           onsubmit="return false;" style="margin:0 25px 10px 50px;float: right;"/>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<script>

    // function to read SAM output
    function readOutputJSON() {
        var key = getCookie('task_id');
        // TODO: change to correct base url
        var url = "/ubertool/rest/ubertool/sam/data/" + key.toString();
        var samOutput = null;
        $.ajax({
            type: "GET",
            url: url,
            async: false,
            success: function (data) {
                console.log("Read output JSON from file: " + url.toString());
                console.log("Output JSON data contents...");
                console.log(data.toString());
                samOutput = data;
                return false;
            },
            error: function (jqXHR, status) {
                console.log("Failed to retrieve output json data.");
                $('#boxid').html("Error attempting to get river data.");
                return false;
            }
        });
        return samOutput
    }

    // Determine if output is points or lines
    function getMode(outputData) {
        var outputMode = outputData.features[0].geometry.type;
        return outputMode
    }

    function exceedanceColor(d) {
        if (d > 0.5) {
            return "#d73027"
        } else if (d > 0.4) {
            return "#fc8d59"
        } else if (d > 0.3) {
            return "#fee090"
        } else if (d > 0.2) {
            return "#e0f3f8"
        } else if (d > 0.1) {
            return "#91bfdb"
        } else {
            return "#4575b4"
        }
    }

    function intakeStyle(feature, field) {
        return {
            radius: 10,
            fillColor: exceedanceColor(feature.properties[field]),
            color: exceedanceColor(feature.properties[field]),
            weight: 5,
            opacity: 1,
            fillOpacity: 0.5
        };
    }

    //stream style
    function streamStyle(feature, field) {
        return {
            weight: 1,
            opacity: 1,
            color: exceedanceColor(feature.properties[field])
        };
    }

    function clearMap() {
        map.eachLayer(function (layer) {
            map.removeLayer(layer);
        });
    }

    // initialize the map
    var map = L.map('map').setView([39.609280, -92.100678], 8);
    // sets variable for selected stream
    var selectedStream;
    // sets the Huc for the selected stream
    var selectedIntake;

    // read model output
    var outputData = readOutputJSON();

    // get feature output mode
    var mode = getMode(outputData);

    // specify field (placeholder)
    var field = "chronic_em_inv";

    // add out data
    var info_box_title = null;
    var info_box_id = null;
    var outLayer = null;
    function displayOutput(field) {
        if (mode == "Point") {
            outLayer = L.geoJSON(outputData, {
                onEachFeature: function (feature, layer) {
                    layer.on({
                        click: function (e) {
                            var lat = feature.geometry.coordinates[0];
                            var lng = feature.geometry.coordinates[1];
                            $('#boxid').html(feature.properties.SystemName);
                            $('#latVal').html(Number(lat).toFixed(6));
                            $('#lngVal').html(Number(lng).toFixed(6));
                            populateFilteredTable(feature.properties)
                        }
                    })
                },
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, intakeStyle(feature, field));
                }
            }).addTo(map);
            info_box_title = "Drinking Water Intake Info"
            info_box_id = "System"
        } else {
            outLayer = L.geoJson(outputData, {
                style: function (feature) {
                    return streamStyle(feature, field)
                }
            }).addTo(map);
            map.on('click', onStreamMapClick);
            info_box_title = "Stream Segment Info"
            info_box_id = "ComID"
        }

    }

    function refreshOutput(newfield) {
        map.removeLayer(outLayer);
        displayOutput(newfield.value);
    }

    displayOutput(field)

    // load a tile layer
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);


    // -------------- BASE MAP code -------------- //

    var layer = L.esri.basemapLayer('NationalGeographic').addTo(map);
    var layerLabels;

    function setBasemap(basemap) {
        if (layer) {
            map.removeLayer(layer);
        }

        layer = L.esri.basemapLayer(basemap);

        map.addLayer(layer);

        if (layerLabels) {
            map.removeLayer(layerLabels);
        }

        if (basemap === 'ShadedRelief'
                || basemap === 'Imagery'
                || basemap === 'Terrain'
                || basemap === 'Topographic'
        ) {
            layerLabels = L.esri.basemapLayer(basemap + 'Labels');
            map.addLayer(layerLabels);
        }
    }

    function changeBasemap(basemaps) {
        var basemap = basemaps.value;
        setBasemap(basemap);
        addStreams();
    }

    // ------------ STREAM NETWORK code ------------- //

    //L.control.layers(streamNetwork).addTo(map);
    function addStreams() {
        L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
            layers: 4,
            format: 'image/png',
            minZoom: 0,
            maxZoom: 18,
            transparent: true
        }).addTo(map);
    }

    addStreams();
    // --------------- INFO WINDOW code -------------- //

    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'stream_info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        this._div.innerHTML = '<h5>' + info_box_title + '</h5>' +
        '<table id="stream_info_table" style="margin-bottom: 0px !important; background: none !important;"> ' +
        '<tr><td>Latitude:</td> <td id="latVal"></td></tr>' +
        '<tr><td>Longitude:</td><td id="lngVal"></td></tr>' +
        '<tr><td>' + info_box_id + '</td><td id="boxid"></td></tr>';
    };

    info.addTo(map);

</script>
</body>
</html>