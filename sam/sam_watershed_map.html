<style>
    #map {
        width: 100%;
        height: 450px;
    }

    #basemaps-wrapper {
        background: white;
        padding: 10px;
        width: 100%;
    }

    {#datatables font size#}
    th {
        font-size: 12px;
    }

    td {
        font-size: 11px;
    }

    .table {
        border-bottom: 0 !important;
    }

    #acuteFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #acuteFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    #chronicFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #chronicFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    #overallFilteredTable tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #overallFilteredTable th * {
        border: 0 !important;
        border-bottom: solid;
        border-bottom-width: 1px;
    }

    .box > .pane-content {
        border-bottom-width: 1px !important;
    }

    {#remove all EPA css transitions for leaflet map#}
    div.mapNoTransition * {
        -o-transition-property: none !important;
        -moz-transition-property: none !important;
        -ms-transition-property: none !important;
        -webkit-transition-property: none !important;
        transition-property: none !important;
        transition: none !important;
    }

    .stream_info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    #stream_info h5 {
        margin: 0 0 5px;
        color: #777;
    }

    #stream_info_table table {
        width: 100%;
    }

    #stream_info_table td {
        font-size: 9px;
        border: none !important;
        background: rgba(255, 255, 255, 0.0);
        padding: 2px 3px !important;
    }

    #pestTable table > tbody > tr > td {
        border-style: none;
    }

    #pestTable table {
        border: black 1px solid;
    }

    #tbl_col {
        background-color: lightgray;
    }

</style>

<head>

    <!-- jquery -->
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <!-- datatables import -->
{#    <link rel="stylesheet"#}
{#          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">#}
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- leaflet import -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>

    <!-- local js stream lines, watershed bnds, -->
    <script src="/static_qed/sam/mtb_flowline_simple.js"></script>
    <script src="/static_qed/sam/testExposureOutput.js"></script>
    <script src="/static_qed/pisces/scripts/huc250k_4326_sp.js"></script>


    <script>

        //  create placeholder global comid variable
        var comid = 5641438;
        console.log(comid);
        $(document).ready(function () {
{#            $('#samWatershedTable').DataTable();#}
            $('#csvSave').on("click", saveTableAsCSV);
        });

        function onStreamMapClick(e) {
            getStreamData(e.latlng.lat, e.latlng.lng);
        }

        //ajax call using lat long for stream data
        function getStreamData(lat, lng) {
            var url = "https://ofmpub.epa.gov/waters10/PointIndexing.Service";
            var latitude = lat.toString();
            var longitude = lng.toString();
            $('#latVal').html(Number(latitude).toFixed(6));
            $('#lngVal').html(Number(longitude).toFixed(6));

            var ptIndexParams = {
                'pGeometry': 'POINT(' + longitude + ' ' + latitude + ')'
                , 'pGeometryMod': 'WKT,SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'pPointIndexingMethod': 'DISTANCE'
                , 'pPointIndexingMaxDist': 25
                , 'pOutputPathFlag': 'TRUE'
                , 'pReturnFlowlineGeomFlag': 'TRUE'
                , 'optOutCS': 'SRSNAME=urn:ogc:def:crs:OGC::CRS84'
                , 'optOutPrettyPrint': 0
            };

            $.ajax({
                type: "GET",
                url: url,
                jsonp: true,
                data: ptIndexParams,
                success: function (data, status, jqXHR) {
                    var streamData = JSON.parse(data);
                    $('#comid').html(streamData.output.ary_flowlines[0].comid);
                    $('#huc8').html(streamData.output.ary_flowlines[0].wbd_huc12.substring(0, 8));
                    addStreamSeg(streamData);
                    setTimeout(getDynamicFile, 300);
                    return false;
                },
                error: function (jqXHR, status) {
                    $('#comId').html("Error attempting to get river data.");
                    return false;
                }
            });
        }

        function getDynamicFile() {
            // TODO: Need to collect key from cookies and set to var key
            var key = "somerandomstring";
            var url = "/sam/bin/results/" + key;
            console.log("Dynamic File Path: " + url.toString());
            $.ajax({
                type: "GET",
                url: url,
                success: function (data, status, jqXHR) {
                    populateFilteredTable(data);
                    return false;
                },
                error: function (jqXHR, status) {
                    console.log("Dynamic File Load Error: " + status.toString());
                    getTESTExposureData();
                }
            });
        }

        <!--- add stream to map -->
        function addStreamSeg(streamData) {
            comid = streamData.output.ary_flowlines[0].comid;
            console.log(comid);
            var latlon = streamData.output.ary_flowlines[0].shape.coordinates.map(function (c) {
                return c.reverse();
            });
            var huc8 = getStreamHuc(streamData.output.ary_flowlines[0].wbd_huc12);
            var huc8geom;
            if (huc8[0][0] < 0) {
                huc8geom = huc8.map(function (c) {
                    return c.reverse();
                });
            }
            else {
                huc8geom = huc8;
            }
            if (map.hasLayer(selectedStream)) {
                map.removeLayer(selectedStream);
                map.removeLayer(streamHuc);
            }
            selectedStream = L.polyline(latlon, {
                color: '#02bfe7',
                weight: 8,
                opacity: 0.9,
                lineJoin: 'round'
            }).addTo(map);
            streamHuc = L.polygon(huc8geom, {
                color: 'white',
                weight: 2,
                opacity: 0.9,
                fillColor: '#9ecae1',
                fillOpacity: 0.3
            }).addTo(map);
            map.fitBounds(selectedStream.getBounds());
        }

        function populateFilteredTable(data) {
            data = data[comid];
            //convert object into an array of objects
            var dataHtml = "<h4 style=\"text-align: center; width: 100%\">Probability of Pesticide Concentration Exceedance</h4>" +
                "<table id='samWatershedTable'>" +
                "<thead style='display:none;'><th></th><th></th><th></th><th></th><th></th><th></th></thead>" +
                "<tbody>" +
                "<tr><td id='tbl_col'>Acute Em Fish</td><td>" + data["acute_em_fish"] + "</td>" +
                "<td id='tbl_col'>Chronic Em Fish</td><td>" + data["chronic_em_fish"] + "</td>" +
                "<td id='tbl_col'>Overall Em Fish</td><td>" + data["overall_em_fish"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Em Inv</td><td>" + data["acute_em_inv"] + "</td>" +
                "<td id='tbl_col'>Chronic Em Inv</td><td>" + data["chronic_em_inv"] + "</td>" +
                "<td id='tbl_col'>Overall Em Inv</td><td>" + data["overall_em_inv"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Fw Fish</td><td>" + data["acute_fw_fish"] + "</td>" +
                "<td id='tbl_col'>Chronic Fw Fish</td><td>" + data["chronic_fw_fish"] + "</td>" +
                "<td id='tbl_col'>Overall Fw Fish</td><td>" + data["overall_fw_fish"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Fw Inv</td><td>" + data["acute_fw_inv"] + "</td>" +
                "<td id='tbl_col'>Chronic Fw Inv</td><td>" + data["chronic_fw_inv"] + "</td>" +
                "<td id='tbl_col'>Overall Fw Inv</td><td>" + data["overall_fw_inv"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Human</td><td>" + data["acute_human"] + "</td>" +
                "<td id='tbl_col'>Chronic Human</td><td>" + data["chronic_human"] + "</td>" +
                "<td id='tbl_col'>Overall Human</td><td>" + data["overall_human"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Nonvasc Plant</td><td>" + data["acute_nonvasc_plant"] + "</td>" +
                "<td id='tbl_col'>Chronic Nonvasc Plant</td><td>" + data["chronic_nonvasc_plant"] + "</td>" +
                "<td id='tbl_col'>Overall Nonvasc Plant</td><td>" + data["overall_nonvasc_plant"] + "</td></tr>" +
                "<tr><td id='tbl_col'>Acute Vasc Plant</td><td>" + data["acute_vasc_plant"] + "</td>" +
                "<td id='tbl_col'>Chronic Vasc Plant</td><td>" + data["chronic_vasc_plant"] + "</td>" +
                "<td id='tbl_col'>Overall Vasc Plant</td><td>" + data["overall_vasc_plant"] + "</td></tr>" +
                "</tbody>" +
                "</table>";
            $('#pestTable').html(dataHtml);
            $('#saveTable').show();
        }

        <!--- get HUC -->
        function getStreamHuc(hucID) {
            var huc8 = null;
            L.geoJSON(huc8s, {
                filter: function (feature, layer) {
                    if (feature.properties.HUC_CODE === hucID.substring(0, 8)) {
                        huc8 = feature.geometry.coordinates[0];
                    }
                }
            });
            return huc8;
        }

        function saveTableAsCSV() {
            var data = "";
{#            var td = $('#samWatershedTable').DataTable();#}
            var config = {
                sorting: false,
                searching: false,
                paging: false,
                bInfo: false
            };
            $('#samWatershedTable').DataTable(config).rows().data().map(function (r) {
                data += r.toString() + "\n";
            });

            var mainHeader = "SAM Pesticide Probabilities \n";
            var metaHeader = "COMID, HUCID, Latitude, Longitude \n";
            var metadata = $('#comid').html() + ", " + $('#huc8').html() + ", " +
                $('#latVal').html() + ", " + $('#lngVal').html() + "\n";
            var fileName = "SAM_pesticide_" + comid;
            var pom = document.createElement('a');
            pom.setAttribute('href', 'data:data:text/csv;charset=utf-8,' + encodeURIComponent(mainHeader + "\n" + metaHeader + metadata + "\n" + data));
            pom.setAttribute('download', fileName + '.csv');
            if (document.createEvent) {
                var event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
            }
            else {
                pom.click();
            }
        }

    </script>

</head>


<body>
<!--- content div -->
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">
        <div class="col-md-10">
            <div class="box multi news">

                <!--- map and info -->
                <div class="pane-content" id="mapDiv">
                    <p><strong>Select a stream</strong> on the map to view the local probability of pesticide exceedance
                        for various populations.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)">
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="Topographic">Topographic</option>
                            <option value="Streets">Streets</option>
                            <option value="Imagery">Imagery</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                </div>

                <br>
                <div id="pest">
                    <div id="pestTable">
                        <table id="samWatershedTable"></table>
                    </div>
                </div>
                <div id="saveTable" style="display:none;">
                    <input id="csvSave" name="save" type="submit" value="Save to CSV"
                           onsubmit="return false;" style="margin:0 25px 10px 50px;float: right;"/>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<script>


    //stream style
    function streamStyle(feature) {
        return {
            weight: .5,
            opacity: 0.9,
            color: 'blue',
        };
    }


    // initialize the map
    var map = L.map('map').setView([39.609280, -92.100678], 8);
    // sets variable for selected stream
    var selectedStream;
    // sets the Huc for the selected stream
    var streamHuc;

    // load huc watershed boundaries
    var markTwainStreams = L.geoJson(markTwainStreams, {
        style: streamStyle,
    }).addTo(map);

    // load a tile layer
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);


    // -------------- BASE MAP code -------------- //

    var layer = L.esri.basemapLayer('NationalGeographic').addTo(map);
    var layerLabels;

    function setBasemap(basemap) {
        if (layer) {
            map.removeLayer(layer);
        }

        layer = L.esri.basemapLayer(basemap);

        map.addLayer(layer);

        if (layerLabels) {
            map.removeLayer(layerLabels);
        }

        if (basemap === 'ShadedRelief'
            || basemap === 'Imagery'
            || basemap === 'Terrain'
            || basemap === 'Topographic'
        ) {
            layerLabels = L.esri.basemapLayer(basemap + 'Labels');
            map.addLayer(layerLabels);
        }
    }

    function changeBasemap(basemaps) {
        var basemap = basemaps.value;
        setBasemap(basemap);
        addStreams();
    }

    // ------------ STREAM NETWORK code ------------- //

    //L.control.layers(streamNetwork).addTo(map);
    function addStreams() {
        L.tileLayer.wms('https://watersgeo.epa.gov/arcgis/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/WmsServer??', {
            layers: 4,
            format: 'image/png',
            minZoom: 0,
            maxZoom: 18,
            transparent: true
        }).addTo(map);
    }

    map.on('click', onStreamMapClick);
    addStreams();
    // --------------- INFO WINDOW code -------------- //

    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'stream_info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        this._div.innerHTML = '<h5>Stream Segment Info</h5>' +
            '<table id="stream_info_table" style="margin-bottom: 0px !important; background: none !important;"> ' +
            '<tr><td>Latitude:</td> <td id="latVal"></td></tr>' +
            '<tr><td>Longitude:</td><td id="lngVal"></td></tr>' +
            '<tr><td>Com ID:</td><td id="comid"></td></tr>' +
            '<td>WBD HUC8:</td><td id="huc8"></td>';
    };

    info.addTo(map);

</script>
</body>
</html>